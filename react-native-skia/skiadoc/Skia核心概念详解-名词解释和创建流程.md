# Skia æ ¸å¿ƒæ¦‚å¿µè¯¦è§£ - åè¯è§£é‡Šå’Œåˆ›å»ºæµç¨‹

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜ 1ï¼šå¯¹è±¡åˆ›å»ºä½ç½®å’Œå…³è”å…³ç³»](#1-é—®é¢˜-1å¯¹è±¡åˆ›å»ºä½ç½®å’Œå…³è”å…³ç³»)
2. [é—®é¢˜ 2ï¼šå…³é”®åè¯è¯¦è§£](#2-é—®é¢˜-2å…³é”®åè¯è¯¦è§£)
3. [é—®é¢˜ 3ï¼šæ¸²æŸ“æµç¨‹å’Œå¸§ç‡æ§åˆ¶è¯¦è§£](#3-é—®é¢˜-3æ¸²æŸ“æµç¨‹å’Œå¸§ç‡æ§åˆ¶è¯¦è§£)

---

## 1. é—®é¢˜ 1ï¼šå¯¹è±¡åˆ›å»ºä½ç½®å’Œå…³è”å…³ç³»

### 1.1 åˆ›å»ºä½ç½®å’Œå…³è”å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ArkTS å±‚ (SkiaDomView.ets)                                 â”‚
â”‚                                                              â”‚
â”‚  XComponent({                                                â”‚
â”‚    type: XComponentType.SURFACE,  â† åˆ›å»º XComponent å¯¹è±¡   â”‚
â”‚    libraryname: "rnoh_skia"                                  â”‚
â”‚  })                                                          â”‚
â”‚                                                              â”‚
â”‚  ç³»ç»Ÿè‡ªåŠ¨åˆ›å»º â†’ OHNativeWindow*                              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ OnSurfaceCreated å›è°ƒ
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  C++ å±‚ (plugin_render.cpp)                                 â”‚
â”‚                                                              â”‚
â”‚  OnSurfaceCreatedCB()                                        â”‚
â”‚    â†“                                                         â”‚
â”‚  OH_NativeXComponent_GetXComponentSize()                     â”‚
â”‚    â†“                                                         â”‚
â”‚  render->m_window = static_cast<OHNativeWindow*>(window)     â”‚
â”‚                    â† ä¿å­˜ OHNativeWindow* æŒ‡é’ˆ               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ surfaceAvailable(window, width, height)
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  C++ å±‚ (RNSkOpenGLCanvasProvider.h)                        â”‚
â”‚                                                              â”‚
â”‚  surfaceAvailable()                                          â”‚
â”‚    â†“                                                         â”‚
â”‚  WindowSurfaceHolder(window, width, height)                  â”‚
â”‚                    â† åˆ›å»º WindowSurfaceHolder                â”‚
â”‚    â†“                                                         â”‚
â”‚  ä¿å­˜ OHNativeWindow* åˆ° _window æˆå‘˜å˜é‡                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ getSurface() (é¦–æ¬¡æ¸²æŸ“æ—¶è°ƒç”¨)
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  C++ å±‚ (WindowSurfaceHolder::getSurface())                  â”‚
â”‚                                                              â”‚
â”‚  1. SkiaOpenGLHelper::createWindowedSurface(_window)        â”‚
â”‚     â† ä» OHNativeWindow åˆ›å»º EGLSurface                     â”‚
â”‚                                                              â”‚
â”‚  2. SkSurfaces::WrapBackendRenderTarget(...)                 â”‚
â”‚     â† ä» EGLSurface åˆ›å»º SkSurface                          â”‚
â”‚                                                              â”‚
â”‚  3. _skSurface->getCanvas()                                 â”‚
â”‚     â† ä» SkSurface è·å– SkCanvas                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è¯¦ç»†åˆ›å»ºæµç¨‹

#### 1.2.1 OHNativeWindow åˆ›å»º

**ä½ç½®ï¼š** HarmonyOS ç³»ç»Ÿå±‚ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰

**è§¦å‘ï¼š** XComponent åˆ›å»ºæ—¶

**ä»£ç ä½ç½®ï¼š**
```typescript
// SkiaDomView.ets:38
XComponent({
    type: XComponentType.SURFACE,  // â† æŒ‡å®š SURFACE ç±»å‹
    libraryname: "rnoh_skia"
})
```

**ç³»ç»Ÿè¡Œä¸ºï¼š**
- HarmonyOS ç³»ç»Ÿæ£€æµ‹åˆ° `XComponentType.SURFACE`
- è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŸç”Ÿçª—å£ï¼ˆNative Windowï¼‰
- é€šè¿‡ `OnSurfaceCreated` å›è°ƒä¼ é€’ç»™ C++ å±‚

**è·å–æ–¹å¼ï¼š**
```cpp
// plugin_render.cpp:43
void OnSurfaceCreatedCB(OH_NativeXComponent *component, void *window) {
    // window å‚æ•°å°±æ˜¯ç³»ç»Ÿåˆ›å»ºçš„ OHNativeWindow*
    OHNativeWindow *nativeWindow = static_cast<OHNativeWindow *>(window);
    render->m_window = nativeWindow;  // â† ä¿å­˜æŒ‡é’ˆ
}
```

---

#### 1.2.2 XComponent å¯¹è±¡åˆ›å»º

**ä½ç½®ï¼š** ArkTS å±‚ï¼ˆSkiaDomView.etsï¼‰

**åˆ›å»ºæ—¶æœºï¼š** React ç»„ä»¶æ¸²æŸ“æ—¶

**ä»£ç ï¼š**
```typescript
// SkiaDomView.ets:38
XComponent({
    id: X_COMPONENT_ID + "_" + this.nativeID,
    type: XComponentType.SURFACE,
    libraryname: "rnoh_skia",
    controller: this.xComponentController
})
```

**ä½œç”¨ï¼š**
- æä¾›åŸç”Ÿ Surface å®¹å™¨
- æ¡¥æ¥ ArkTS UI å’Œ C++ åŸç”Ÿä»£ç 
- ç®¡ç† Surface ç”Ÿå‘½å‘¨æœŸ

---

#### 1.2.3 WindowSurfaceHolder åˆ›å»º

**ä½ç½®ï¼š** C++ å±‚ï¼ˆRNSkOpenGLCanvasProvider.hï¼‰

**åˆ›å»ºæ—¶æœºï¼š** `surfaceAvailable()` è¢«è°ƒç”¨æ—¶

**ä»£ç ï¼š**
```cpp
// RNSkOpenGLCanvasProvider.h:400
void surfaceAvailable(OHNativeWindow *surface, int width, int height) {
    // åˆ›å»º WindowSurfaceHolderï¼Œä¼ å…¥ OHNativeWindow*
    _surfaceHolder = SkiaOpenGLSurfaceFactory::makeWindowedSurface(
        surface, width, height);
}
```

**å…³è”å…³ç³»ï¼š**
```
WindowSurfaceHolder
â”œâ”€ _window = OHNativeWindow*  â† ä¿å­˜åŸç”Ÿçª—å£æŒ‡é’ˆ
â”œâ”€ _glSurface = EGL_NO_SURFACE  â† åˆå§‹ä¸ºç©ºï¼Œåç»­åˆ›å»º
â””â”€ _skSurface = nullptr  â† åˆå§‹ä¸ºç©ºï¼Œåç»­åˆ›å»º
```

---

#### 1.2.4 EGLSurface åˆ›å»º

**ä½ç½®ï¼š** C++ å±‚ï¼ˆWindowSurfaceHolder::getSurface()ï¼‰

**åˆ›å»ºæ—¶æœºï¼š** é¦–æ¬¡è°ƒç”¨ `getSurface()` æ—¶

**ä»£ç ï¼š**
```cpp
// RNSkOpenGLCanvasProvider.h:96
_glSurface = SkiaOpenGLHelper::createWindowedSurface(_window);
//                                                      â†‘
//                                        ä» OHNativeWindow åˆ›å»º
```

**å…³è”å…³ç³»ï¼š**
```
OHNativeWindow* (_window)
    â†“ createWindowedSurface()
    â†“
EGLSurface (_glSurface)
```

**ä½œç”¨ï¼š**
- EGLSurface æ˜¯ OpenGL æ¸²æŸ“çš„ç›®æ ‡è¡¨é¢
- å°† OHNativeWindow åŒ…è£…æˆ EGL å¯ç”¨çš„è¡¨é¢

---

#### 1.2.5 SkSurface åˆ›å»º

**ä½ç½®ï¼š** C++ å±‚ï¼ˆWindowSurfaceHolder::getSurface()ï¼‰

**åˆ›å»ºæ—¶æœºï¼š** é¦–æ¬¡è°ƒç”¨ `getSurface()` æ—¶ï¼ˆåœ¨ EGLSurface åˆ›å»ºä¹‹åï¼‰

**ä»£ç ï¼š**
```cpp
// RNSkOpenGLCanvasProvider.h:136-155
auto renderTarget = GrBackendRenderTargets::MakeGL(_width, _height, ...);

_skSurface = SkSurfaces::WrapBackendRenderTarget(
    directContext, renderTarget,
    kBottomLeft_GrSurfaceOrigin, colorType, nullptr, &props, ...);
```

**å…³è”å…³ç³»ï¼š**
```
EGLSurface (_glSurface)
    â†“ WrapBackendRenderTarget()
    â†“
SkSurface (_skSurface)
```

**ä½œç”¨ï¼š**
- SkSurface æ˜¯ Skia çš„æ¸²æŸ“è¡¨é¢
- å°† EGLSurface åŒ…è£…æˆ Skia å¯ç”¨çš„è¡¨é¢

---

#### 1.2.6 SkCanvas è·å–

**ä½ç½®ï¼š** C++ å±‚ï¼ˆWindowSurfaceHolder::getSurface() æˆ– renderToCanvas()ï¼‰

**è·å–æ–¹å¼ï¼š**
```cpp
// ä» SkSurface è·å– Canvas
SkCanvas* canvas = _skSurface->getCanvas();
```

**å…³è”å…³ç³»ï¼š**
```
SkSurface (_skSurface)
    â†“ getCanvas()
    â†“
SkCanvas* (canvas)
```

**æ³¨æ„ï¼š**
- Canvas ä¸æ˜¯ç‹¬ç«‹åˆ›å»ºçš„å¯¹è±¡
- å®ƒæ˜¯ SkSurface çš„ä¸€ä¸ªè§†å›¾ï¼ˆViewï¼‰
- é€šè¿‡ `getCanvas()` æ–¹æ³•è·å–

---

### 1.3 å®Œæ•´å…³è”å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºé¡ºåºå’Œå…³è”å…³ç³»                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. XComponent (ArkTS)                                      â”‚
â”‚     â””â”€ ç³»ç»Ÿè‡ªåŠ¨åˆ›å»º â†’ OHNativeWindow*                        â”‚
â”‚                                                              â”‚
â”‚  2. OnSurfaceCreated å›è°ƒ                                    â”‚
â”‚     â””â”€ ä¼ é€’ OHNativeWindow* åˆ° C++                          â”‚
â”‚                                                              â”‚
â”‚  3. WindowSurfaceHolder (C++)                               â”‚
â”‚     â””â”€ ä¿å­˜ OHNativeWindow* åˆ° _window                      â”‚
â”‚                                                              â”‚
â”‚  4. getSurface() é¦–æ¬¡è°ƒç”¨                                    â”‚
â”‚     â”œâ”€ createWindowedSurface(_window)                       â”‚
â”‚     â”‚   â””â”€ åˆ›å»º EGLSurface                                  â”‚
â”‚     â”‚                                                       â”‚
â”‚     â””â”€ WrapBackendRenderTarget(EGLSurface)                  â”‚
â”‚         â””â”€ åˆ›å»º SkSurface                                   â”‚
â”‚                                                              â”‚
â”‚  5. renderToCanvas() æ¯æ¬¡æ¸²æŸ“                                â”‚
â”‚     â””â”€ getSurface() â†’ getCanvas()                          â”‚
â”‚         â””â”€ è·å– SkCanvas*                                   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. é—®é¢˜ 2ï¼šå…³é”®åè¯è¯¦è§£

### 2.1 OHNativeWindow

**å…¨ç§°ï¼š** OpenHarmony Native Window

**å®šä¹‰ï¼š** HarmonyOS ç³»ç»Ÿæä¾›çš„åŸç”Ÿçª—å£å¥æŸ„

**ä½œç”¨ï¼š**
- ä»£è¡¨ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå¯æ¸²æŸ“çª—å£
- æ˜¯ OpenGL/EGL æ¸²æŸ“çš„æœ€ç»ˆç›®æ ‡
- ç”±ç³»ç»Ÿåˆ›å»ºå’Œç®¡ç†

**ç”Ÿå‘½å‘¨æœŸï¼š**
```
ç³»ç»Ÿåˆ›å»º â†’ OnSurfaceCreated å›è°ƒ â†’ C++ ä¿å­˜æŒ‡é’ˆ â†’ ä½¿ç”¨ â†’ OnSurfaceDestroyed â†’ ç³»ç»Ÿé”€æ¯
```

**åœ¨ä»£ç ä¸­çš„ä½ç½®ï¼š**
```cpp
// plugin_render.cpp:67
OHNativeWindow *nativeWindow = static_cast<OHNativeWindow *>(window);
render->m_window = nativeWindow;  // â† ä¿å­˜åˆ° PluginRender

// RNSkOpenGLCanvasProvider.h:239
OHNativeWindow *_window;  // â† WindowSurfaceHolder çš„æˆå‘˜å˜é‡
```

---

### 2.2 EGLSurface

**å…¨ç§°ï¼š** EGL Surface

**å®šä¹‰ï¼š** EGLï¼ˆEmbedded-System Graphics Libraryï¼‰æ¸²æŸ“è¡¨é¢

**ä½œç”¨ï¼š**
- OpenGL æ¸²æŸ“çš„ç›®æ ‡è¡¨é¢
- è¿æ¥ OpenGL å’Œç³»ç»Ÿçª—å£
- ç®¡ç†å‰åç¼“å†²åŒº

**åˆ›å»ºæ–¹å¼ï¼š**
```cpp
// HarmonyOpenGLHelper.h (æ¨æµ‹)
EGLSurface createWindowedSurface(OHNativeWindow *window) {
    // ä» OHNativeWindow åˆ›å»º EGLSurface
    return eglCreateWindowSurface(display, config, window, attribs);
}
```

**å…³è”å…³ç³»ï¼š**
```
OHNativeWindow* â†’ EGLSurface â†’ OpenGL æ¸²æŸ“ç›®æ ‡
```

**ç”Ÿå‘½å‘¨æœŸï¼š**
```
åˆ›å»º (getSurface) â†’ ä½¿ç”¨ (makeCurrent) â†’ é”€æ¯ (dispose)
```

---

### 2.3 SkSurface

**å…¨ç§°ï¼š** Skia Surface

**å®šä¹‰ï¼š** Skia å›¾å½¢åº“çš„æ¸²æŸ“è¡¨é¢

**ä½œç”¨ï¼š**
- Skia ç»˜åˆ¶çš„ç›®æ ‡è¡¨é¢
- ç®¡ç† Skia çš„æ¸²æŸ“ä¸Šä¸‹æ–‡
- æä¾› SkCanvas æ¥å£

**åˆ›å»ºæ–¹å¼ï¼š**
```cpp
// RNSkOpenGLCanvasProvider.h:147
_skSurface = SkSurfaces::WrapBackendRenderTarget(
    directContext,           // Skia GPU ä¸Šä¸‹æ–‡
    renderTarget,            // ä» EGLSurface åˆ›å»ºçš„æ¸²æŸ“ç›®æ ‡
    kBottomLeft_GrSurfaceOrigin,  // åæ ‡åŸç‚¹
    colorType, nullptr, &props, ...);
```

**å…³è”å…³ç³»ï¼š**
```
EGLSurface â†’ GrBackendRenderTarget â†’ SkSurface
```

**ç”Ÿå‘½å‘¨æœŸï¼š**
```
åˆ›å»º (getSurface) â†’ ä½¿ç”¨ (renderToCanvas) â†’ é”€æ¯ (resize/dispose)
```

---

### 2.4 SkCanvas

**å…¨ç§°ï¼š** Skia Canvas

**å®šä¹‰ï¼š** Skia çš„ç”»å¸ƒæ¥å£ï¼Œç”¨äºæ‰§è¡Œç»˜åˆ¶æ“ä½œ

**ä½œç”¨ï¼š**
- æä¾›ç»˜åˆ¶ APIï¼ˆdrawRect, drawText, drawImage ç­‰ï¼‰
- ç®¡ç†ç»˜åˆ¶çŠ¶æ€ï¼ˆå˜æ¢çŸ©é˜µã€è£å‰ªåŒºåŸŸç­‰ï¼‰
- è®°å½•ç»˜åˆ¶å‘½ä»¤

**è·å–æ–¹å¼ï¼š**
```cpp
// ä» SkSurface è·å–
SkCanvas* canvas = _skSurface->getCanvas();
```

**é‡è¦æ–¹æ³•ï¼š**
```cpp
canvas->resetMatrix();           // é‡ç½®å˜æ¢çŸ©é˜µ
canvas->clipRect(...);            // è®¾ç½®è£å‰ªåŒºåŸŸ
canvas->drawRect(...);            // ç»˜åˆ¶çŸ©å½¢
canvas->drawText(...);            // ç»˜åˆ¶æ–‡æœ¬
canvas->drawImage(...);           // ç»˜åˆ¶å›¾ç‰‡
```

**æ³¨æ„ï¼š**
- Canvas ä¸æ˜¯ç‹¬ç«‹å¯¹è±¡ï¼Œæ˜¯ SkSurface çš„è§†å›¾
- æ¯æ¬¡ `getCanvas()` è¿”å›çš„æ˜¯åŒä¸€ä¸ª Canvas å¯¹è±¡
- Canvas çš„çŠ¶æ€ï¼ˆçŸ©é˜µã€è£å‰ªç­‰ï¼‰ä¼šä¿ç•™

---

### 2.5 getSurface()

**å®šä¹‰ï¼š** WindowSurfaceHolder çš„æ–¹æ³•ï¼Œè·å–æˆ–åˆ›å»º SkSurface

**ä½œç”¨ï¼š**
- æ‡’åŠ è½½ï¼šé¦–æ¬¡è°ƒç”¨æ—¶åˆ›å»º EGLSurface å’Œ SkSurface
- ç¼“å­˜ï¼šåç»­è°ƒç”¨ç›´æ¥è¿”å›å·²åˆ›å»ºçš„ SkSurface
- é‡å»ºï¼šresize() åï¼Œä¸‹æ¬¡è°ƒç”¨ä¼šé‡æ–°åˆ›å»º

**ä»£ç æµç¨‹ï¼š**
```cpp
sk_sp<SkSurface> getSurface() {
    if (_skSurface == nullptr) {  // â† é¦–æ¬¡è°ƒç”¨æˆ– resize å
        // 1. åˆ›å»º EGLSurface
        _glSurface = createWindowedSurface(_window);
        
        // 2. åˆ›å»º SkSurface
        _skSurface = WrapBackendRenderTarget(...);
        
        // 3. é‡ç½® Canvas çŸ©é˜µ
        canvas->resetMatrix();
    }
    return _skSurface;  // â† è¿”å›ç¼“å­˜çš„ SkSurface
}
```

**è°ƒç”¨æ—¶æœºï¼š**
- é¦–æ¬¡æ¸²æŸ“æ—¶
- resize() åçš„é¦–æ¬¡æ¸²æŸ“
- æ¯æ¬¡ `renderToCanvas()` æ—¶

---

### 2.6 present()

**å®šä¹‰ï¼š** WindowSurfaceHolder çš„æ–¹æ³•ï¼Œæäº¤æ¸²æŸ“ç»“æœå¹¶ä¸Šå±

**ä½œç”¨ï¼š**
- åˆ·æ–° GPU å‘½ä»¤é˜Ÿåˆ—
- äº¤æ¢å‰åç¼“å†²åŒº
- å°†å¸§æäº¤ç»™ç³»ç»Ÿåˆæˆå™¨

**ä»£ç ï¼š**
```cpp
// RNSkOpenGLCanvasProvider.h:226
bool present() {
    // 1. åˆ·æ–°å¹¶æäº¤ GPU å‘½ä»¤
    directContext->flushAndSubmit();
    
    // 2. äº¤æ¢å‰åç¼“å†²åŒº
    return SkiaOpenGLHelper::swapBuffers(display, _glSurface);
}
```

**æ‰§è¡Œæµç¨‹ï¼š**
```
ç»˜åˆ¶å®Œæˆ â†’ flushAndSubmit() â†’ swapBuffers() â†’ ç³»ç»Ÿåˆæˆ â†’ æ˜¾ç¤º
```

**è°ƒç”¨æ—¶æœºï¼š**
- æ¯æ¬¡ `renderToCanvas()` å®Œæˆå
- å¿…é¡»è°ƒç”¨ï¼Œå¦åˆ™ç”»é¢ä¸ä¼šæ›´æ–°

---

### 2.7 flushAndSubmit()

**å®šä¹‰ï¼š** GrDirectContext çš„æ–¹æ³•ï¼Œåˆ·æ–°å¹¶æäº¤ GPU å‘½ä»¤

**ä½œç”¨ï¼š**
- å°† Skia å½•åˆ¶çš„ GPU å‘½ä»¤å‘é€åˆ° GPU é©±åŠ¨
- ç¡®ä¿æ‰€æœ‰ç»˜åˆ¶å‘½ä»¤éƒ½å·²æäº¤
- ç­‰å¾… GPU æ‰§è¡Œå®Œæˆï¼ˆå¯é€‰ï¼‰

**ä»£ç ï¼š**
```cpp
// RNSkOpenGLCanvasProvider.h:228
ThreadContextHarmonyHolder::ThreadSkiaOpenGLContext.directContext->flushAndSubmit();
```

**æ‰§è¡Œå†…å®¹ï¼š**
```
Skia ç»˜åˆ¶çš„å‘½ä»¤é˜Ÿåˆ—
    â†“ flush()
    â†“
GPU é©±åŠ¨å‘½ä»¤é˜Ÿåˆ—
    â†“ submit()
    â†“
GPU æ‰§è¡Œ
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼š**
- Skia ä½¿ç”¨å‘½ä»¤ç¼“å†²ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œ
- éœ€è¦æ˜¾å¼åˆ·æ–°æ‰èƒ½å‘é€åˆ° GPU
- ä¸è°ƒç”¨çš„è¯ï¼Œç»˜åˆ¶ä¸ä¼šæ˜¾ç¤º

---

### 2.8 swapBuffers()

**å®šä¹‰ï¼š** EGL å‡½æ•°ï¼Œäº¤æ¢å‰åç¼“å†²åŒº

**ä½œç”¨ï¼š**
- äº¤æ¢å‰åç¼“å†²åŒºï¼ˆDouble Bufferingï¼‰
- å°†åç¼“å†²åŒºï¼ˆåˆšç»˜åˆ¶çš„å†…å®¹ï¼‰æ˜¾ç¤ºåˆ°å±å¹•
- å‰ç¼“å†²åŒºå˜æˆæ–°çš„åç¼“å†²åŒºï¼Œç”¨äºä¸‹æ¬¡ç»˜åˆ¶

**ä»£ç ï¼š**
```cpp
// HarmonyOpenGLHelper.h (æ¨æµ‹)
bool swapBuffers(EGLDisplay display, EGLSurface surface) {
    return eglSwapBuffers(display, surface);
}
```

**Double Buffering åŸç†ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç¼“å†²åŒº    â”‚         â”‚  åç¼“å†²åŒº    â”‚
â”‚  (æ˜¾ç¤ºä¸­)    â”‚         â”‚  (ç»˜åˆ¶ä¸­)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                       â†“
   å±å¹•æ˜¾ç¤º              æ­£åœ¨ç»˜åˆ¶æ–°å¸§
      â†“                       â†“
   swapBuffers()  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
   äº¤æ¢ç¼“å†²åŒº
      â†“
   åç¼“å†²åŒº â†’ å‰ç¼“å†²åŒº (æ˜¾ç¤º)
   å‰ç¼“å†²åŒº â†’ åç¼“å†²åŒº (ç»˜åˆ¶)
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼š**
- é¿å…ç”»é¢æ’•è£‚ï¼ˆTearingï¼‰
- ä¿è¯ç”»é¢å®Œæ•´æ€§
- æä¾›æµç•…çš„è§†è§‰ä½“éªŒ

---

## 3. é—®é¢˜ 3ï¼šæ¸²æŸ“æµç¨‹å’Œå¸§ç‡æ§åˆ¶è¯¦è§£

### 3.1 HarmonyPlayLink è¯¦è§£

#### 3.1.1 å®šä¹‰å’Œä½œç”¨

**å…¨ç§°ï¼š** Harmony Play Linkï¼ˆæ’­æ”¾é“¾æ¥ï¼‰

**ä½œç”¨ï¼š** å®šæ—¶å™¨ï¼Œå®šæœŸè§¦å‘æ¸²æŸ“é€šçŸ¥

**ä¸æ˜¯ï¼š**
- âŒ ä¸æ˜¯æ¸²æŸ“å™¨ï¼ˆä¸æ‰§è¡Œå®é™…ç»˜åˆ¶ï¼‰
- âŒ ä¸æ˜¯å¸§ç‡æ§åˆ¶å™¨ï¼ˆä¸æ§åˆ¶ GPU å¸§ç‡ï¼‰
- âŒ ä¸æ˜¯åŒæ­¥å™¨ï¼ˆä¸ç­‰å¾…å‚ç›´åŒæ­¥ï¼‰

**æ˜¯ï¼š**
- âœ… å®šæ—¶è§¦å‘å™¨ï¼ˆæ¯ 16.667ms è§¦å‘ä¸€æ¬¡ï¼‰
- âœ… é€šçŸ¥å™¨ï¼ˆé€šçŸ¥éœ€è¦æ¸²æŸ“ï¼‰
- âœ… å¾ªç¯ç®¡ç†å™¨ï¼ˆç®¡ç†æ¸²æŸ“å¾ªç¯ï¼‰

#### 3.1.2 å·¥ä½œåŸç†

```cpp
// HarmonyPlayLink.cpp:33
void PlayLink::postFrameLoop() {
    auto lastTime = std::chrono::steady_clock::now();
    auto nextTime = lastTime + interval;  // interval = 16.667ms
    
    while (running) {
        std::this_thread::sleep_until(nextTime);  // ç¡çœ åˆ°æŒ‡å®šæ—¶é—´
        
        auto currentTime = std::chrono::steady_clock::now();
        double deltaTime = ...;  // è®¡ç®—æ—¶é—´å·®
        
        CallBack(deltaTime);  // â† è§¦å‘å›è°ƒ
        
        nextTime = lastTime + interval;  // è®¡ç®—ä¸‹æ¬¡æ—¶é—´
    }
}
```

**æ‰§è¡Œæµç¨‹ï¼š**
```
å¯åŠ¨çº¿ç¨‹ â†’ è¿›å…¥å¾ªç¯ â†’ ç¡çœ  16.667ms â†’ é†’æ¥ â†’ è°ƒç”¨å›è°ƒ â†’ é‡å¤
```

#### 3.1.3 å›è°ƒé“¾

```
PlayLink::postFrameLoop()
    â†“ CallBack(deltaTime)
    â†“
å¤–å±‚ Lambda: [this](double deltaTime) {
    runOnMainThread([this](){
        notifyDrawLoop(false);
    });
}
    â†“
HarmonyPlatformContext::notifyDrawLoop()
    â†“
RNSkView::draw()
    â†“
RNSkOpenGLCanvasProvider::renderToCanvas()
    â†“
å®é™…æ¸²æŸ“æ‰§è¡Œ
```

---

### 3.2 16.667ms è¯¦è§£

#### 3.2.1 ä¸ºä»€ä¹ˆæ˜¯ 16.667msï¼Ÿ

**è®¡ç®—ï¼š**
```
60fps = 60 frames per second
1 ç§’ = 1000 æ¯«ç§’
1000ms Ã· 60 = 16.666...ms â‰ˆ 16.667ms
```

**å«ä¹‰ï¼š**
- æ¯å¸§é—´éš” 16.667ms
- æ¯ç§’ 60 å¸§
- åŒ¹é…æ ‡å‡† 60Hz åˆ·æ–°ç‡

#### 3.2.2 ä»£ç ä¸­çš„å®šä¹‰

```cpp
// HarmonyPlayLink.h:20
PlayLink(std::function<void(double)> CallBack, 
         double interval_ms = 16.667);  // â† é»˜è®¤ 16.667ms

// HarmonyPlatformContext.cpp:42
playLink(std::make_unique<PlayLink>([this](double deltaTime) {
    // ...
}))  // â† ä½¿ç”¨é»˜è®¤å€¼ 16.667ms
```

#### 3.2.3 å®é™…æ‰§è¡Œæ—¶é—´

**ç†æƒ³æƒ…å†µï¼š**
```
T0: æ‰§è¡Œå›è°ƒ
T1: T0 + 16.667msï¼Œæ‰§è¡Œå›è°ƒ
T2: T1 + 16.667msï¼Œæ‰§è¡Œå›è°ƒ
...
```

**å®é™…æƒ…å†µï¼š**
- å¯èƒ½æœ‰å»¶è¿Ÿï¼ˆæ‰§è¡Œæ—¶é—´ã€ç³»ç»Ÿè°ƒåº¦ç­‰ï¼‰
- `deltaTime` ä¼šåæ˜ å®é™…æ—¶é—´å·®
- `sleep_until` ä¼šè¡¥å¿å»¶è¿Ÿï¼Œä¿æŒç¨³å®šé—´éš”

---

### 3.3 flushAndSubmit() è¯¦è§£

#### 3.3.1 ä½œç”¨

**å°† Skia ç»˜åˆ¶çš„å‘½ä»¤å‘é€åˆ° GPU å¹¶æäº¤æ‰§è¡Œ**

#### 3.3.2 æ‰§è¡Œå†…å®¹

```
Skia ç»˜åˆ¶å‘½ä»¤
â”œâ”€ drawRect() â†’ GPU å‘½ä»¤ 1
â”œâ”€ drawText() â†’ GPU å‘½ä»¤ 2
â”œâ”€ drawImage() â†’ GPU å‘½ä»¤ 3
â””â”€ ...

    â†“ flush()
    â†“
GPU é©±åŠ¨å‘½ä»¤é˜Ÿåˆ—
â”œâ”€ å‘½ä»¤ 1
â”œâ”€ å‘½ä»¤ 2
â”œâ”€ å‘½ä»¤ 3
â””â”€ ...

    â†“ submit()
    â†“
GPU æ‰§è¡Œ
â””â”€ å®é™…æ¸²æŸ“åˆ°å¸§ç¼“å†²åŒº
```

#### 3.3.3 ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ

**Skia ä½¿ç”¨å‘½ä»¤ç¼“å†²ï¼š**
- ç»˜åˆ¶æ“ä½œä¸ä¼šç«‹å³æ‰§è¡Œ
- å…ˆè®°å½•åˆ°å‘½ä»¤ç¼“å†²åŒº
- éœ€è¦æ˜¾å¼åˆ·æ–°æ‰èƒ½å‘é€åˆ° GPU

**ç±»æ¯”ï¼š**
```
å†™æ–‡ä»¶æ—¶ï¼Œæ•°æ®å…ˆåˆ°ç¼“å†²åŒº
éœ€è¦ flush() æ‰èƒ½å†™å…¥ç£ç›˜

Skia ç»˜åˆ¶æ—¶ï¼Œå‘½ä»¤å…ˆåˆ°ç¼“å†²åŒº
éœ€è¦ flushAndSubmit() æ‰èƒ½å‘é€åˆ° GPU
```

#### 3.3.4 æ€§èƒ½å½±å“

**è€—æ—¶ï¼š**
- å–å†³äºç»˜åˆ¶å¤æ‚åº¦
- ç®€å•åœºæ™¯ï¼š< 1ms
- å¤æ‚åœºæ™¯ï¼šå¯èƒ½ > 10ms

**ä¼˜åŒ–ï¼š**
- å‡å°‘ç»˜åˆ¶å‘½ä»¤æ•°é‡
- ä½¿ç”¨æ‰¹å¤„ç†
- é¿å…é¢‘ç¹ flush

---

### 3.4 swapBuffers() è¯¦è§£

#### 3.4.1 ä½œç”¨

**äº¤æ¢å‰åç¼“å†²åŒºï¼Œå°†æ–°å¸§æ˜¾ç¤ºåˆ°å±å¹•**

#### 3.4.2 Double Buffering

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç¼“å†²åŒº (Front Buffer)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å½“å‰æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å†…å®¹          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ swapBuffers()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç¼“å†²åŒº (Back Buffer)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ­£åœ¨ç»˜åˆ¶çš„æ–°å†…å®¹                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤æ¢åï¼š**
```
åç¼“å†²åŒº â†’ å‰ç¼“å†²åŒº (æ˜¾ç¤º)
å‰ç¼“å†²åŒº â†’ åç¼“å†²åŒº (ç»˜åˆ¶)
```

#### 3.4.3 ä¸ºä»€ä¹ˆéœ€è¦ Double Bufferingï¼Ÿ

**é—®é¢˜ï¼šå•ç¼“å†²**
```
ç»˜åˆ¶ â†’ æ˜¾ç¤º â†’ ç»˜åˆ¶ â†’ æ˜¾ç¤º
      â†‘
   å¯èƒ½çœ‹åˆ°ç»˜åˆ¶è¿‡ç¨‹ï¼ˆæ’•è£‚ï¼‰
```

**è§£å†³ï¼šåŒç¼“å†²**
```
åç¼“å†²åŒºç»˜åˆ¶ â†’ swapBuffers() â†’ å‰ç¼“å†²åŒºæ˜¾ç¤º
                                    â†‘
                              å®Œæ•´ç”»é¢ï¼Œæ— æ’•è£‚
```

#### 3.4.4 å‚ç›´åŒæ­¥ï¼ˆVSyncï¼‰

**swapBuffers() å¯èƒ½è¢« VSync é˜»å¡ï¼š**
```
swapBuffers() è°ƒç”¨
    â†“
ç­‰å¾… VSync ä¿¡å·ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    â†“
VSync åˆ°è¾¾
    â†“
äº¤æ¢ç¼“å†²åŒº
    â†“
è¿”å›
```

**VSync é¢‘ç‡ï¼š**
- 60Hz æ˜¾ç¤ºå™¨ï¼šæ¯ 16.667ms ä¸€æ¬¡
- 120Hz æ˜¾ç¤ºå™¨ï¼šæ¯ 8.333ms ä¸€æ¬¡

---

### 3.5 60Hz å’Œ 120Hz åˆ‡æ¢è¯¦è§£

#### 3.5.1 å¸§ç‡æ¥æº

**60Hzï¼š**
- PlayLink å®šæ—¶å™¨ï¼š16.667ms é—´éš”
- åŒ¹é… 60Hz æ˜¾ç¤ºå™¨åˆ·æ–°ç‡

**120Hzï¼š**
- éœ€è¦ä¿®æ”¹ PlayLink é—´éš”ï¼š8.333ms
- åŒ¹é… 120Hz æ˜¾ç¤ºå™¨åˆ·æ–°ç‡

#### 3.5.2 å¦‚ä½•åˆ‡æ¢ï¼Ÿ

**æ–¹å¼ 1ï¼šä¿®æ”¹ PlayLink é—´éš”**

```cpp
// å½“å‰ä»£ç ï¼ˆ60Hzï¼‰
playLink(std::make_unique<PlayLink>([this](double deltaTime) {
    // ...
}))  // é»˜è®¤ 16.667ms

// æ”¹ä¸º 120Hz
playLink(std::make_unique<PlayLink>([this](double deltaTime) {
    // ...
}, 8.333))  // 8.333ms = 120fps
```

**æ–¹å¼ 2ï¼šåŠ¨æ€æ£€æµ‹æ˜¾ç¤ºå™¨åˆ·æ–°ç‡**

```cpp
// è·å–æ˜¾ç¤ºå™¨åˆ·æ–°ç‡
float refreshRate = getDisplayRefreshRate();  // 60 æˆ– 120

// è®¡ç®—é—´éš”
double interval_ms = 1000.0 / refreshRate;  // 16.667 æˆ– 8.333

// åˆ›å»º PlayLink
playLink(std::make_unique<PlayLink>(callback, interval_ms));
```

#### 3.5.3 å®é™…å¸§ç‡é™åˆ¶

**PlayLink å®šæ—¶å™¨ï¼š**
- æ§åˆ¶**è§¦å‘é¢‘ç‡**ï¼ˆé€šçŸ¥æ¸²æŸ“çš„é¢‘ç‡ï¼‰
- ä¸æ§åˆ¶**å®é™…æ¸²æŸ“é€Ÿåº¦**

**å®é™…å¸§ç‡å—é™äºï¼š**
1. **PlayLink é—´éš”**ï¼ˆ16.667ms = 60fpsï¼Œ8.333ms = 120fpsï¼‰
2. **æ¸²æŸ“è€—æ—¶**ï¼ˆå¦‚æœæ¸²æŸ“ > 16.667msï¼Œå®é™… < 60fpsï¼‰
3. **VSync**ï¼ˆswapBuffers ç­‰å¾… VSyncï¼‰
4. **ç³»ç»Ÿè´Ÿè½½**ï¼ˆCPU/GPU å‹åŠ›ï¼‰

#### 3.5.4 è‡ªé€‚åº”å¸§ç‡

**ç†æƒ³å®ç°ï¼š**
```cpp
void PlayLink::postFrameLoop() {
    while (running) {
        auto startTime = std::chrono::steady_clock::now();
        
        CallBack(deltaTime);  // è§¦å‘æ¸²æŸ“
        
        auto endTime = std::chrono::steady_clock::now();
        auto renderTime = endTime - startTime;
        
        // å¦‚æœæ¸²æŸ“å¾ˆå¿«ï¼Œå¯ä»¥æå‰è§¦å‘ä¸‹ä¸€å¸§
        // å¦‚æœæ¸²æŸ“å¾ˆæ…¢ï¼Œä¿æŒå›ºå®šé—´éš”
        auto sleepTime = interval - renderTime;
        if (sleepTime > 0) {
            std::this_thread::sleep_for(sleepTime);
        }
    }
}
```

---

### 3.6 å®Œæ•´æ¸²æŸ“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. PlayLink å®šæ—¶å™¨ (æ¯ 16.667ms)                        â”‚
â”‚     â””â”€ postFrameLoop() å¾ªç¯                              â”‚
â”‚         â””â”€ CallBack(deltaTime)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. é€šçŸ¥æ¸²æŸ“                                             â”‚
â”‚     â””â”€ notifyDrawLoop()                                 â”‚
â”‚         â””â”€ RNSkView::draw()                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ‰§è¡Œç»˜åˆ¶                                             â”‚
â”‚     â””â”€ renderToCanvas(cb)                               â”‚
â”‚         â”œâ”€ getSurface() â†’ è·å– SkSurface                â”‚
â”‚         â”œâ”€ makeCurrent() â†’ ç»‘å®š EGLSurface              â”‚
â”‚         â”œâ”€ cb(canvas) â†’ æ‰§è¡Œ JS å±‚ç»˜åˆ¶å›è°ƒ              â”‚
â”‚         â”‚   â””â”€ canvas->drawXXX() â†’ Skia ç»˜åˆ¶å‘½ä»¤        â”‚
â”‚         â””â”€ present() â†’ ä¸Šå±                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æäº¤åˆ° GPU                                           â”‚
â”‚     â””â”€ flushAndSubmit()                                 â”‚
â”‚         â”œâ”€ flush() â†’ å‘é€å‘½ä»¤åˆ° GPU                      â”‚
â”‚         â””â”€ submit() â†’ æäº¤æ‰§è¡Œ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. äº¤æ¢ç¼“å†²åŒº                                           â”‚
â”‚     â””â”€ swapBuffers()                                    â”‚
â”‚         â”œâ”€ ç­‰å¾… VSyncï¼ˆå¦‚æœå¯ç”¨ï¼‰                        â”‚
â”‚         â””â”€ äº¤æ¢å‰åç¼“å†²åŒº                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. ç³»ç»Ÿæ˜¾ç¤º                                             â”‚
â”‚     â””â”€ HarmonyOS åˆæˆå™¨                                  â”‚
â”‚         â””â”€ æ˜¾ç¤ºåˆ°å±å¹•                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. æ€»ç»“

### 4.1 å¯¹è±¡åˆ›å»ºä½ç½®

| å¯¹è±¡ | åˆ›å»ºä½ç½® | åˆ›å»ºæ—¶æœº |
|------|---------|---------|
| **OHNativeWindow** | ç³»ç»Ÿå±‚ | XComponent åˆ›å»ºæ—¶ |
| **XComponent** | ArkTS å±‚ | React ç»„ä»¶æ¸²æŸ“æ—¶ |
| **WindowSurfaceHolder** | C++ å±‚ | surfaceAvailable() æ—¶ |
| **EGLSurface** | C++ å±‚ | getSurface() é¦–æ¬¡è°ƒç”¨ |
| **SkSurface** | C++ å±‚ | getSurface() é¦–æ¬¡è°ƒç”¨ |
| **SkCanvas** | C++ å±‚ | getSurface() æˆ– renderToCanvas() |

### 4.2 å…³é”®åè¯ä½œç”¨

| åè¯ | ä½œç”¨ |
|------|------|
| **OHNativeWindow** | ç³»ç»ŸåŸç”Ÿçª—å£å¥æŸ„ |
| **EGLSurface** | OpenGL æ¸²æŸ“è¡¨é¢ |
| **SkSurface** | Skia æ¸²æŸ“è¡¨é¢ |
| **SkCanvas** | Skia ç”»å¸ƒæ¥å£ |
| **getSurface()** | è·å–/åˆ›å»º SkSurface |
| **present()** | æäº¤æ¸²æŸ“å¹¶ä¸Šå± |
| **flushAndSubmit()** | åˆ·æ–°å¹¶æäº¤ GPU å‘½ä»¤ |
| **swapBuffers()** | äº¤æ¢å‰åç¼“å†²åŒº |

### 4.3 æ¸²æŸ“æµç¨‹

1. **PlayLink** å®šæ—¶è§¦å‘ï¼ˆ16.667ms = 60fpsï¼‰
2. **notifyDrawLoop()** é€šçŸ¥éœ€è¦æ¸²æŸ“
3. **renderToCanvas()** æ‰§è¡Œç»˜åˆ¶
4. **flushAndSubmit()** æäº¤åˆ° GPU
5. **swapBuffers()** äº¤æ¢ç¼“å†²åŒº
6. **ç³»ç»Ÿæ˜¾ç¤º** åˆæˆå¹¶æ˜¾ç¤º

### 4.4 å¸§ç‡æ§åˆ¶

- **PlayLink é—´éš”**ï¼šæ§åˆ¶è§¦å‘é¢‘ç‡ï¼ˆ16.667ms = 60fpsï¼Œ8.333ms = 120fpsï¼‰
- **å®é™…å¸§ç‡**ï¼šå—æ¸²æŸ“è€—æ—¶ã€VSyncã€ç³»ç»Ÿè´Ÿè½½å½±å“
- **åˆ‡æ¢æ–¹å¼**ï¼šä¿®æ”¹ PlayLink çš„ interval_ms å‚æ•°

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ç»´æŠ¤è€…**: AI Assistant
