# Canvasã€XComponentã€NativeWindowã€Surface å°ºå¯¸ä¼ é€’æµç¨‹è¯¦è§£

## ğŸ“‹ é—®é¢˜

1. ä¸€ä¸ª Canvas å¯¹åº” PluginRender çš„ä¸€ä¸ªå®ä¾‹ - âœ… æ­£ç¡®
2. Canvasã€XComponentã€NativeWindowã€Surface çš„å°ºå¯¸æ˜¯æ€ä¹ˆä¼ é€’çš„ï¼Ÿ

## ğŸ¯ ç­”æ¡ˆ

**å°ºå¯¸ä¼ é€’æµç¨‹ï¼š**
```
Canvas style (width/height)
    â†“ RNOH å¸ƒå±€ç³»ç»Ÿ
XComponent (viewWidth/viewHeight)
    â†“ ç³»ç»Ÿåˆ›å»º
NativeWindow (ç³»ç»Ÿè·å–å°ºå¯¸)
    â†“ OnSurfaceCreated å›è°ƒ
PluginRender (m_width/m_height)
    â†“ surfaceAvailable()
WindowSurfaceHolder (_width/_height)
    â†“ getSurface()
Surface (ä½¿ç”¨ _width/_height åˆ›å»º)
```

---

## 1. å°ºå¯¸ä¼ é€’å®Œæ•´æµç¨‹

### 1.1 æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Canvas ç»„ä»¶ (React Native JS å±‚)                    â”‚
â”‚     style={{width: '100%', height: gridHeight}}         â”‚
â”‚     â†“                                                    â”‚
â”‚     RNOH å¸ƒå±€ç³»ç»Ÿè®¡ç®—å®é™…å°ºå¯¸                            â”‚
â”‚     ä¾‹å¦‚ï¼šwidth: 375px, height: 400px                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. RNCSkiaDomView.ets (RNOH æ¡¥æ¥å±‚)                     â”‚
â”‚     descriptor.layoutMetrics.frame.size                  â”‚
â”‚     â”œâ”€ width: 375px                                     â”‚
â”‚     â””â”€ height: 400px                                    â”‚
â”‚     â†“                                                    â”‚
â”‚     this.viewWidth = layoutMetrics.frame.size.width     â”‚
â”‚     this.viewHeight = layoutMetrics.frame.size.height   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ä¼ é€’ç»™
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. SkiaDomView.ets (ArkTS å±‚)                          â”‚
â”‚     SkiaDomView({                                        â”‚
â”‚       viewWidth: this.viewWidth,   // 375px             â”‚
â”‚       viewHeight: this.viewHeight  // 400px             â”‚
â”‚     })                                                   â”‚
â”‚     â†“                                                    â”‚
â”‚     XComponent({                                         â”‚
â”‚       width: this.viewWidth,   // 375px                  â”‚
â”‚       height: this.viewHeight  // 400px                  â”‚
â”‚     })                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ç³»ç»Ÿåˆ›å»º NativeWindow
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. OnSurfaceCreated å›è°ƒ (ç³»ç»Ÿå±‚)                       â”‚
â”‚     OH_NativeXComponent_GetXComponentSize(               â”‚
â”‚       component, window, &width, &height                â”‚
â”‚     )                                                    â”‚
â”‚     â†“                                                    â”‚
â”‚     è·å–å°ºå¯¸ï¼šwidth: 375px, height: 400px               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ä¿å­˜åˆ°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. PluginRender (C++ å±‚)                               â”‚
â”‚     render->m_width = width;   // 375px                  â”‚
â”‚     render->m_height = height; // 400px                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ surfaceAvailable()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. WindowSurfaceHolder (C++ å±‚)                        â”‚
â”‚     WindowSurfaceHolder(window, width, height)           â”‚
â”‚     â†“                                                    â”‚
â”‚     _width = width;   // 375px                           â”‚
â”‚     _height = height; // 400px                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ getSurface()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Surface åˆ›å»º (C++ å±‚)                                â”‚
â”‚     GrBackendRenderTargets::MakeGL(                     â”‚
â”‚       _width, _height, ...  // 375px, 400px            â”‚
â”‚     )                                                    â”‚
â”‚     â†“                                                    â”‚
â”‚     SkSurfaces::WrapBackendRenderTarget(...)            â”‚
â”‚     â†“                                                    â”‚
â”‚     åˆ›å»º SkSurface (å°ºå¯¸: 375px Ã— 400px)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. è¯¦ç»†ä»£ç æµç¨‹

### 2.1 Canvas ç»„ä»¶å®šä¹‰å°ºå¯¸

**ä½ç½®ï¼š** React Native JS å±‚

```typescript
// example/src/skia/index.tsx:431
<Canvas
  style={{
    width: '100%',        // â† ç›¸å¯¹å®½åº¦
    height: gridHeight,    // â† è®¡ç®—çš„é«˜åº¦ï¼ˆä¾‹å¦‚ï¼š400pxï¼‰
  }}>
```

**è¯´æ˜ï¼š**
- `width: '100%'` - ç›¸å¯¹å®½åº¦ï¼Œç”±çˆ¶å®¹å™¨å†³å®š
- `height: gridHeight` - è®¡ç®—çš„é«˜åº¦ï¼ˆä¾‹å¦‚ï¼š400pxï¼‰
- RNOH å¸ƒå±€ç³»ç»Ÿä¼šè®¡ç®—å®é™…åƒç´ å€¼

---

### 2.2 RNOH æ¡¥æ¥å±‚è·å–å°ºå¯¸

**ä½ç½®ï¼š** RNCSkiaDomView.ets

```typescript
// RNCSkiaDomView.ets:79
updatePropFromDesc(): void {
    // ä» RN çš„å¸ƒå±€ä¿¡æ¯ä¸­è·å–å°ºå¯¸
    this.viewWidth = this.descriptor.layoutMetrics.frame.size.width   // â† ä¾‹å¦‚ï¼š375px
    this.viewHeight = this.descriptor.layoutMetrics.frame.size.height // â† ä¾‹å¦‚ï¼š400px
}
```

**è¯´æ˜ï¼š**
- `descriptor.layoutMetrics` - RNOH æä¾›çš„å¸ƒå±€ä¿¡æ¯
- `frame.size.width/height` - å®é™…åƒç´ å°ºå¯¸
- è¿™äº›å°ºå¯¸å·²ç»ç”± RNOH å¸ƒå±€ç³»ç»Ÿè®¡ç®—å®Œæˆ

**ä¼ é€’ç»™ SkiaDomViewï¼š**
```typescript
// RNCSkiaDomView.ets:97
SkiaDomView({
    nativeID: this.nativeID,
    viewWidth: this.viewWidth,   // â† 375px
    viewHeight: this.viewHeight  // â† 400px
})
```

---

### 2.3 XComponent ä½¿ç”¨å°ºå¯¸

**ä½ç½®ï¼š** SkiaDomView.ets

```typescript
// SkiaDomView.ets:37
build() {
    XComponent({
        id: X_COMPONENT_ID + "_" + this.nativeID,
        type: XComponentType.SURFACE,
        libraryname: "rnoh_skia",
        controller: this.xComponentController
    })
    .width(this.viewWidth)   // â† 375px
    .height(this.viewHeight) // â† 400px
}
```

**è¯´æ˜ï¼š**
- XComponent ä½¿ç”¨ `viewWidth` å’Œ `viewHeight` è®¾ç½®å°ºå¯¸
- ç³»ç»Ÿä¼šæ ¹æ®è¿™äº›å°ºå¯¸åˆ›å»ºå¯¹åº”å¤§å°çš„ NativeWindow

**å°ºå¯¸å˜åŒ–å¤„ç†ï¼š**
```typescript
// SkiaDomView.ets:50
.onSizeChange((oldValue: SizeOptions, newValue: SizeOptions) => {
    let width = newValue.width?.valueOf() as number;   // â† æ–°çš„å®½åº¦
    let height = newValue.height?.valueOf() as number;  // â† æ–°çš„é«˜åº¦
    this.xComponentContext?.onSurfaceSizeChanged(
        X_COMPONENT_ID + "_" + this.nativeID, 
        this.nativeID, 
        width, 
        height
    );
})
```

---

### 2.4 ç³»ç»Ÿåˆ›å»º NativeWindow å¹¶è·å–å°ºå¯¸

**ä½ç½®ï¼š** plugin_render.cpp (OnSurfaceCreated å›è°ƒ)

```cpp
// plugin_render.cpp:43
void OnSurfaceCreatedCB(OH_NativeXComponent *component, void *window) {
    // 1. è·å– XComponent çš„ ID
    OH_NativeXComponent_GetXComponentId(component, idStr, &idSize);
    std::string id(idStr);
    
    // 2. è·å– XComponent çš„å°ºå¯¸
    uint64_t width;
    uint64_t height;
    OH_NativeXComponent_GetXComponentSize(component, window, &width, &height);
    //                                                      â†‘        â†‘
    //                                                    è·å–å®½åº¦  è·å–é«˜åº¦
    //                                                    ä¾‹å¦‚ï¼š375px  400px
    
    // 3. ä¿å­˜åˆ° PluginRender å®ä¾‹
    auto render = PluginRender::GetInstance(id);
    render->m_width = width;   // â† 375px
    render->m_height = height; // â† 400px
    render->m_window = static_cast<OHNativeWindow *>(window);
}
```

**è¯´æ˜ï¼š**
- `OH_NativeXComponent_GetXComponentSize()` - ä» XComponent è·å–å°ºå¯¸
- ç³»ç»Ÿå·²ç»æ ¹æ® XComponent çš„ width/height åˆ›å»ºäº†å¯¹åº”å¤§å°çš„ NativeWindow
- è¿™ä¸ªå°ºå¯¸å°±æ˜¯ XComponent è®¾ç½®çš„å°ºå¯¸

---

### 2.5 PluginRender ä¿å­˜å°ºå¯¸

**ä½ç½®ï¼š** plugin_render.h

```cpp
// plugin_render.h:228
class PluginRender {
public:
    OHNativeWindow *m_window;
    uint64_t m_width;   // â† ä¿å­˜å®½åº¦ï¼ˆä¾‹å¦‚ï¼š375pxï¼‰
    uint64_t m_height; // â† ä¿å­˜é«˜åº¦ï¼ˆä¾‹å¦‚ï¼š400pxï¼‰
    // ...
};
```

**è¯´æ˜ï¼š**
- `m_width` å’Œ `m_height` ä¿å­˜ä»ç³»ç»Ÿè·å–çš„å°ºå¯¸
- è¿™äº›å°ºå¯¸ä¼šåœ¨åç»­ä¼ é€’ç»™ WindowSurfaceHolder

---

### 2.6 surfaceAvailable ä¼ é€’å°ºå¯¸

**ä½ç½®ï¼š** RNSkOpenGLCanvasProvider.h

```cpp
// RNSkOpenGLCanvasProvider.h:426
void surfaceAvailable(OHNativeWindow *surface, int width, int height) {
    // width å’Œ height æ¥è‡ª PluginRender::RegisterView
    // æˆ–è€…æ¥è‡ª OnSurfaceCreated æ—¶çš„ m_width/m_height
    
    // åˆ›å»º WindowSurfaceHolderï¼Œä¼ å…¥å°ºå¯¸
    _surfaceHolder = SkiaOpenGLSurfaceFactory::makeWindowedSurface(
        surface, width, height);
    //                    â†‘      â†‘
    //                   å®½åº¦   é«˜åº¦
    //                   ä¾‹å¦‚ï¼š375px  400px
}
```

**è°ƒç”¨ä½ç½®ï¼š**
```cpp
// plugin_render.h:76
view->surfaceAvailable(instance->m_window, 1, 1);
//                                    â†‘      â†‘  â†‘
//                                   çª—å£   å®½ é«˜
//                                   æ³¨æ„ï¼šè¿™é‡Œä¼ çš„æ˜¯ 1,1ï¼Œå®é™…å°ºå¯¸åœ¨ OnSurfaceCreated æ—¶è·å–
```

**æ³¨æ„ï¼š** è¿™é‡Œä¼ çš„æ˜¯ `1, 1`ï¼Œä½†å®é™…å°ºå¯¸åœ¨ `OnSurfaceCreated` æ—¶å·²ç»è·å–å¹¶ä¿å­˜åˆ° `m_width/m_height`ã€‚

**å®é™…å°ºå¯¸ä¼ é€’ï¼š**
```cpp
// OnSurfaceCreated æ—¶
render->m_width = width;   // â† 375px
render->m_height = height; // â† 400px

// åç»­ surfaceSizeChanged æ—¶ä½¿ç”¨
view->surfaceSizeChanged(instance->m_width, instance->m_height);
//                        â†‘                â†‘
//                       375px            400px
```

---

### 2.7 WindowSurfaceHolder ä¿å­˜å°ºå¯¸

**ä½ç½®ï¼š** RNSkOpenGLCanvasProvider.h

```cpp
// RNSkOpenGLCanvasProvider.h:43
WindowSurfaceHolder(OHNativeWindow *window, int width, int height) {
    _width = width;   // â† 375px
    _height = height; // â† 400px
    _window = window;
}
```

**è¯´æ˜ï¼š**
- `_width` å’Œ `_height` ä¿å­˜ä¼ å…¥çš„å°ºå¯¸
- è¿™äº›å°ºå¯¸ä¼šåœ¨åˆ›å»º Surface æ—¶ä½¿ç”¨

---

### 2.8 Surface åˆ›å»ºæ—¶ä½¿ç”¨å°ºå¯¸

**ä½ç½®ï¼š** WindowSurfaceHolder::getSurface()

```cpp
// RNSkOpenGLCanvasProvider.h:136
auto renderTarget = GrBackendRenderTargets::MakeGL(
    _width, _height,  // â† ä½¿ç”¨ä¿å­˜çš„å°ºå¯¸ï¼ˆ375px, 400pxï¼‰
    samples, stencil, fboInfo);

// RNSkOpenGLCanvasProvider.h:147
_skSurface = SkSurfaces::WrapBackendRenderTarget(
    directContext, renderTarget,
    kBottomLeft_GrSurfaceOrigin, colorType, nullptr, &props, ...);
```

**è¯´æ˜ï¼š**
- `_width` å’Œ `_height` ç”¨äºåˆ›å»º `GrBackendRenderTarget`
- `GrBackendRenderTarget` çš„å°ºå¯¸å†³å®šäº† `SkSurface` çš„å°ºå¯¸
- æœ€ç»ˆ `SkSurface` çš„å°ºå¯¸å°±æ˜¯ `_width Ã— _height`ï¼ˆ375px Ã— 400pxï¼‰

---

## 3. å°ºå¯¸å˜åŒ–å¤„ç†

### 3.1 å°ºå¯¸å˜åŒ–æµç¨‹

```
Canvas style å°ºå¯¸å˜åŒ–
    â†“
RNOH å¸ƒå±€ç³»ç»Ÿé‡æ–°è®¡ç®—
    â†“
XComponent.onSizeChange è§¦å‘
    â†“
onSurfaceSizeChanged NAPI è°ƒç”¨
    â†“
PluginRender::SurfaceSizeChanged
    â†“
surfaceSizeChanged()
    â†“
WindowSurfaceHolder::resize()
    â†“
_skSurface = nullptr (æ ‡è®°éœ€è¦é‡å»º)
    â†“
ä¸‹æ¬¡ getSurface() æ—¶ä½¿ç”¨æ–°å°ºå¯¸é‡å»º
```

### 3.2 ä»£ç æµç¨‹

**1. XComponent å°ºå¯¸å˜åŒ–ï¼š**
```typescript
// SkiaDomView.ets:50
.onSizeChange((oldValue, newValue) => {
    let width = newValue.width?.valueOf() as number;   // â† æ–°å®½åº¦
    let height = newValue.height?.valueOf() as number; // â† æ–°é«˜åº¦
    this.xComponentContext?.onSurfaceSizeChanged(
        X_COMPONENT_ID + "_" + this.nativeID, 
        this.nativeID, 
        width, 
        height
    );
})
```

**2. NAPI è°ƒç”¨ï¼š**
```cpp
// plugin_render.h:172
static napi_value SurfaceSizeChanged(...) {
    // è§£æå‚æ•°
    auto [v3Succ, width] = nWidth.ToInt32();   // â† æ–°å®½åº¦
    auto [v4Succ, height] = nHeight.ToInt32(); // â† æ–°é«˜åº¦
    
    // æ›´æ–° PluginRender çš„å°ºå¯¸
    instance->m_width = width;
    instance->m_height = height;
    
    // è°ƒç”¨ surfaceSizeChanged
    view->surfaceSizeChanged(instance->m_width, instance->m_height);
}
```

**3. WindowSurfaceHolder å¤„ç†ï¼š**
```cpp
// RNSkOpenGLCanvasProvider.h:449
void surfaceSizeChanged(int width, int height) {
    // è°ƒç”¨ resize
    _surfaceHolder->resize(width, height);
    // ...
}

// RNSkOpenGLCanvasProvider.h:218
void resize(int width, int height) {
    _width = width;   // â† æ›´æ–°å®½åº¦
    _height = height; // â† æ›´æ–°é«˜åº¦
    _skSurface = nullptr; // â† æ ‡è®°éœ€è¦é‡å»º
}
```

**4. ä¸‹æ¬¡æ¸²æŸ“æ—¶é‡å»ºï¼š**
```cpp
// RNSkOpenGLCanvasProvider.h:83
sk_sp<SkSurface> getSurface() {
    if (_skSurface == nullptr) {  // â† resize åä¸º nullptr
        // ä½¿ç”¨æ–°çš„ _width å’Œ _height é‡å»º Surface
        auto renderTarget = GrBackendRenderTargets::MakeGL(
            _width, _height, ...);  // â† ä½¿ç”¨æ–°å°ºå¯¸
        // ...
    }
}
```

---

## 4. å°ºå¯¸ä¼ é€’æ€»ç»“

### 4.1 å®Œæ•´ä¼ é€’é“¾

```
Canvas style
  width: '100%', height: gridHeight
    â†“ RNOH å¸ƒå±€ç³»ç»Ÿè®¡ç®—
å®é™…å°ºå¯¸ï¼š375px Ã— 400px
    â†“
XComponent
  width: 375px, height: 400px
    â†“ ç³»ç»Ÿåˆ›å»º
NativeWindow
  ç³»ç»Ÿæ ¹æ® XComponent å°ºå¯¸åˆ›å»ºï¼š375px Ã— 400px
    â†“ OnSurfaceCreated
PluginRender
  m_width: 375px, m_height: 400px
    â†“ surfaceAvailable/surfaceSizeChanged
WindowSurfaceHolder
  _width: 375px, _height: 400px
    â†“ getSurface()
Surface
  ä½¿ç”¨ _width Ã— _height åˆ›å»ºï¼š375px Ã— 400px
```

### 4.2 å…³é”®ç‚¹

1. **Canvas å°ºå¯¸** â†’ RNOH å¸ƒå±€ç³»ç»Ÿè®¡ç®— â†’ **å®é™…åƒç´ å°ºå¯¸**
2. **å®é™…åƒç´ å°ºå¯¸** â†’ ä¼ é€’ç»™ XComponent â†’ **XComponent å°ºå¯¸**
3. **XComponent å°ºå¯¸** â†’ ç³»ç»Ÿåˆ›å»º NativeWindow â†’ **NativeWindow å°ºå¯¸**
4. **NativeWindow å°ºå¯¸** â†’ OnSurfaceCreated è·å– â†’ **PluginRender å°ºå¯¸**
5. **PluginRender å°ºå¯¸** â†’ surfaceAvailable/surfaceSizeChanged â†’ **WindowSurfaceHolder å°ºå¯¸**
6. **WindowSurfaceHolder å°ºå¯¸** â†’ getSurface() ä½¿ç”¨ â†’ **Surface å°ºå¯¸**

### 4.3 å°ºå¯¸ä¸€è‡´æ€§

**æ‰€æœ‰å±‚çš„å°ºå¯¸åº”è¯¥ä¸€è‡´ï¼š**
- Canvas çš„å®é™…å°ºå¯¸ = XComponent å°ºå¯¸ = NativeWindow å°ºå¯¸ = Surface å°ºå¯¸

**å¦‚æœå°ºå¯¸ä¸ä¸€è‡´ï¼š**
- âŒ ç”»é¢å¯èƒ½è¢«è£å‰ª
- âŒ ç”»é¢å¯èƒ½è¢«æ‹‰ä¼¸
- âŒ åæ ‡è®¡ç®—é”™è¯¯

---

## 5. ä»£ç ä¸­çš„å…³é”®ä½ç½®

### 5.1 å°ºå¯¸è·å–ä½ç½®

| ä½ç½® | ä»£ç  | è¯´æ˜ |
|------|------|------|
| **Canvas** | `style={{width, height}}` | ç”¨æˆ·å®šä¹‰çš„å°ºå¯¸ |
| **RNOH** | `layoutMetrics.frame.size` | å¸ƒå±€ç³»ç»Ÿè®¡ç®—çš„å°ºå¯¸ |
| **XComponent** | `width(this.viewWidth)` | ArkTS ä½¿ç”¨çš„å°ºå¯¸ |
| **NativeWindow** | `GetXComponentSize()` | ç³»ç»Ÿè·å–çš„å°ºå¯¸ |
| **PluginRender** | `m_width, m_height` | C++ ä¿å­˜çš„å°ºå¯¸ |
| **WindowSurfaceHolder** | `_width, _height` | Surface ä½¿ç”¨çš„å°ºå¯¸ |

### 5.2 å°ºå¯¸ä¼ é€’å‡½æ•°

| å‡½æ•° | ä½œç”¨ | å‚æ•° |
|------|------|------|
| `updatePropFromDesc()` | ä» RN è·å–å°ºå¯¸ | `layoutMetrics.frame.size` |
| `GetXComponentSize()` | ä» XComponent è·å–å°ºå¯¸ | `component, window, &width, &height` |
| `surfaceAvailable()` | ä¼ é€’å°ºå¯¸åˆ° SurfaceHolder | `width, height` |
| `resize()` | æ›´æ–° SurfaceHolder å°ºå¯¸ | `width, height` |
| `MakeGL()` | ä½¿ç”¨å°ºå¯¸åˆ›å»º Surface | `_width, _height` |

---

## 6. æ€»ç»“

### 6.1 å…³ç³»ç¡®è®¤

**âœ… ä¸€ä¸ª Canvas å¯¹åº” PluginRender çš„ä¸€ä¸ªå®ä¾‹**

### 6.2 å°ºå¯¸ä¼ é€’æµç¨‹

```
Canvas style
    â†“ RNOH å¸ƒå±€è®¡ç®—
XComponent (viewWidth/viewHeight)
    â†“ ç³»ç»Ÿåˆ›å»º
NativeWindow (ç³»ç»Ÿè·å–å°ºå¯¸)
    â†“ OnSurfaceCreated
PluginRender (m_width/m_height)
    â†“ surfaceAvailable/surfaceSizeChanged
WindowSurfaceHolder (_width/_height)
    â†“ getSurface()
Surface (ä½¿ç”¨ _width/_height åˆ›å»º)
```

### 6.3 å…³é”®ç†è§£

1. **Canvas å°ºå¯¸** â†’ RNOH å¸ƒå±€ç³»ç»Ÿè®¡ç®— â†’ **å®é™…åƒç´ å°ºå¯¸**
2. **æ‰€æœ‰å±‚çš„å°ºå¯¸åº”è¯¥ä¸€è‡´**
3. **å°ºå¯¸å˜åŒ–é€šè¿‡ `onSizeChange` â†’ `surfaceSizeChanged` â†’ `resize()` å¤„ç†**

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ç»´æŠ¤è€…**: AI Assistant
