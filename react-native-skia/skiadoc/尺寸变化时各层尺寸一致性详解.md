# 尺寸变化时各层尺寸一致性详解

## 📋 问题

1. 新的尺寸新的高度是什么？
2. 从上面到下面渲染尺寸都是全部不变的么？

## 🎯 答案

**尺寸变化时：**
- ✅ **理想情况**：所有层的尺寸应该保持一致
- ⚠️ **实际情况**：可能存在时序问题，导致短暂不一致
- ✅ **最终状态**：所有层都会更新到新尺寸

---

## 1. 尺寸变化场景

### 1.1 实际例子

**场景：日历从 5 行切换到 6 行**

```
初始状态（5 行）：
Canvas height: 290px
    ↓
XComponent height: 290px
    ↓
NativeWindow height: 290px
    ↓
Surface height: 290px

变化后（6 行）：
Canvas height: 348px  ← 新高度
    ↓
XComponent height: 348px  ← 新高度
    ↓
NativeWindow height: 348px  ← 新高度
    ↓
Surface height: 348px  ← 新高度
```

**新高度 = 348px**（从 290px 增加到 348px）

---

## 2. 尺寸变化流程

### 2.1 完整流程

```
┌─────────────────────────────────────────────────────────┐
│  1. Canvas 尺寸变化 (React Native JS 层)                 │
│     style={{height: gridHeight}}  // 290px → 348px      │
│     ↓                                                    │
│     RNOH 布局系统重新计算                                │
│     新尺寸：375px × 348px                               │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  2. RNCSkiaDomView 更新尺寸                              │
│     updatePropFromDesc() {                              │
│       this.viewHeight = 348px  // ← 新高度              │
│     }                                                    │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  3. SkiaDomView XComponent 更新尺寸                     │
│     XComponent({                                        │
│       height: this.viewHeight  // 348px ← 新高度         │
│     })                                                   │
│     ↓                                                    │
│     onSizeChange 触发                                   │
│     newValue.height = 348px  // ← 新高度                │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  4. 系统更新 NativeWindow 尺寸                          │
│     系统检测到 XComponent 尺寸变化                       │
│     ↓                                                    │
│     更新 NativeWindow 尺寸：375px × 348px              │
│     ↓                                                    │
│     OnSurfaceChanged 回调触发                            │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  5. PluginRender 更新尺寸                                │
│     OnSurfaceChanged() {                                │
│       OH_NativeXComponent_GetXComponentSize(            │
│         component, window, &width, &height             │
│       )                                                 │
│       // width: 375px, height: 348px ← 新高度          │
│       render->m_width = width;                          │
│       render->m_height = height;  // 348px ← 新高度    │
│     }                                                    │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  6. NAPI onSurfaceSizeChanged 调用                      │
│     PluginRender::SurfaceSizeChanged() {                │
│       // 解析参数                                        │
│       width = 375px                                     │
│       height = 348px  // ← 新高度                       │
│       ↓                                                  │
│       // 更新 PluginRender 尺寸                          │
│       instance->m_width = width;                         │
│       instance->m_height = height;  // 348px            │
│       ↓                                                  │
│       // 调用 surfaceSizeChanged                         │
│       view->surfaceSizeChanged(width, height)           │
│     }                                                    │
└───────────────────┬─────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  7. WindowSurfaceHolder 更新尺寸                         │
│     surfaceSizeChanged(width, height) {                 │
│       _surfaceHolder->resize(width, height)             │
│       // width: 375px, height: 348px                    │
│     }                                                    │
│     ↓                                                    │
│     resize(width, height) {                             │
│       _width = width;   // 375px                        │
│       _height = height; // 348px ← 新高度               │
│       _skSurface = nullptr;  // 标记需要重建            │
│     }                                                    │
└───────────────────┬─────────────────────────────────────┘
                    ↓ 下次渲染时
┌─────────────────────────────────────────────────────────┐
│  8. Surface 重建（使用新尺寸）                           │
│     getSurface() {                                       │
│       if (_skSurface == nullptr) {  // 需要重建         │
│         // 使用新的 _width 和 _height 创建              │
│         GrBackendRenderTargets::MakeGL(                 │
│           _width, _height, ...  // 375px, 348px        │
│         )                                                │
│         ↓                                                │
│         // 创建新的 SkSurface                            │
│         SkSurface (尺寸: 375px × 348px) ← 新尺寸        │
│       }                                                  │
│     }                                                    │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 各层尺寸是否一致？

### 3.1 理想情况（最终状态）

**所有层的尺寸应该一致：**

```
Canvas 实际尺寸: 375px × 348px
    ↓
XComponent 尺寸: 375px × 348px  ✅ 一致
    ↓
NativeWindow 尺寸: 375px × 348px  ✅ 一致
    ↓
PluginRender 尺寸: 375px × 348px  ✅ 一致
    ↓
WindowSurfaceHolder 尺寸: 375px × 348px  ✅ 一致
    ↓
Surface 尺寸: 375px × 348px  ✅ 一致
```

### 3.2 实际情况（变化过程中）

**尺寸变化是异步的，可能存在短暂不一致：**

```
时间 T0: Canvas 尺寸变化
Canvas: 375px × 348px  ✅ 新尺寸
XComponent: 375px × 290px  ⚠️ 旧尺寸（还未更新）
NativeWindow: 375px × 290px  ⚠️ 旧尺寸（还未更新）
Surface: 375px × 290px  ⚠️ 旧尺寸（还未更新）

时间 T1: XComponent 尺寸更新
Canvas: 375px × 348px  ✅
XComponent: 375px × 348px  ✅ 新尺寸
NativeWindow: 375px × 290px  ⚠️ 旧尺寸（系统还未更新）
Surface: 375px × 290px  ⚠️ 旧尺寸

时间 T2: NativeWindow 尺寸更新
Canvas: 375px × 348px  ✅
XComponent: 375px × 348px  ✅
NativeWindow: 375px × 348px  ✅ 新尺寸（系统已更新）
Surface: 375px × 290px  ⚠️ 旧尺寸（还未重建）

时间 T3: Surface 重建
Canvas: 375px × 348px  ✅
XComponent: 375px × 348px  ✅
NativeWindow: 375px × 348px  ✅
Surface: 375px × 348px  ✅ 新尺寸（重建完成）

最终状态：所有层尺寸一致 ✅
```

### 3.3 为什么会有短暂不一致？

**原因：**
1. **异步更新**：各层更新是异步的，不是同步的
2. **时序问题**：Canvas 先变化，XComponent 后更新，NativeWindow 再更新，Surface 最后重建
3. **系统延迟**：系统更新 NativeWindow 需要时间
4. **重建延迟**：Surface 重建发生在下次渲染时

---

## 4. 尺寸传递的时序

### 4.1 同步 vs 异步

**同步部分：**
```
Canvas style 变化
    ↓ 同步
RNOH 布局计算
    ↓ 同步
XComponent 尺寸更新
```

**异步部分：**
```
XComponent 尺寸更新
    ↓ 异步（系统回调）
NativeWindow 尺寸更新
    ↓ 异步（回调触发）
PluginRender 尺寸更新
    ↓ 异步（下次渲染）
Surface 重建
```

### 4.2 关键时序点

**T0: Canvas 尺寸变化**
```
Canvas: 375px × 348px  ✅
其他层: 375px × 290px  ⚠️
```

**T1: onSizeChange 触发**
```
Canvas: 375px × 348px  ✅
XComponent: 375px × 348px  ✅
其他层: 375px × 290px  ⚠️
```

**T2: OnSurfaceChanged 回调**
```
Canvas: 375px × 348px  ✅
XComponent: 375px × 348px  ✅
NativeWindow: 375px × 348px  ✅
PluginRender: 375px × 348px  ✅
Surface: 375px × 290px  ⚠️
```

**T3: 下次渲染时 Surface 重建**
```
所有层: 375px × 348px  ✅ 全部一致
```

---

## 5. 尺寸一致性保证

### 5.1 如何保证最终一致？

**机制 1：resize() 标记重建**
```cpp
// RNSkOpenGLCanvasProvider.h:218
void resize(int width, int height) {
    _width = width;   // 更新尺寸
    _height = height; // 更新尺寸
    _skSurface = nullptr;  // ← 标记需要重建
}
```

**机制 2：getSurface() 懒重建**
```cpp
// RNSkOpenGLCanvasProvider.h:83
sk_sp<SkSurface> getSurface() {
    if (_skSurface == nullptr) {  // ← 检查是否需要重建
        // 使用最新的 _width 和 _height 重建
        auto renderTarget = GrBackendRenderTargets::MakeGL(
            _width, _height, ...);  // ← 使用新尺寸
    }
    return _skSurface;
}
```

**机制 3：每次渲染前重置**
```cpp
// RNSkOpenGLCanvasProvider.h:402
canvas->resetMatrix();
canvas->clipRect(SkRect::MakeWH(
    _surfaceHolder->getWidth(), 
    _surfaceHolder->getHeight()
));  // ← 使用最新的尺寸
```

### 5.2 为什么需要这些机制？

**问题：** 如果 Surface 不重建，会怎样？

```
Canvas: 375px × 348px  ✅
Surface: 375px × 290px  ⚠️ 旧尺寸

绘制时：
- 绘制到 375px × 290px 的 Surface
- 但实际需要 375px × 348px
- 结果：第 6 行被裁剪，不显示
```

**解决：** 重建 Surface，使用新尺寸

```
Canvas: 375px × 348px  ✅
Surface: 375px × 348px  ✅ 新尺寸（重建后）

绘制时：
- 绘制到 375px × 348px 的 Surface
- 所有 6 行都能显示
```

---

## 6. 实际例子：5 行切到 6 行

### 6.1 初始状态（5 行）

```
Canvas height: 290px
XComponent height: 290px
NativeWindow height: 290px
PluginRender m_height: 290px
WindowSurfaceHolder _height: 290px
Surface height: 290px

所有层尺寸一致 ✅
```

### 6.2 变化过程（5 行 → 6 行）

**T0: Canvas 尺寸变化**
```
Canvas height: 348px  ✅ 新高度
其他层: 290px  ⚠️ 旧高度
```

**T1: XComponent 更新**
```
Canvas: 348px  ✅
XComponent: 348px  ✅ 新高度
其他层: 290px  ⚠️
```

**T2: NativeWindow 更新**
```
Canvas: 348px  ✅
XComponent: 348px  ✅
NativeWindow: 348px  ✅ 新高度
PluginRender: 348px  ✅ 新高度
WindowSurfaceHolder: 348px  ✅ 新高度
Surface: 290px  ⚠️ 旧高度（还未重建）
```

**T3: Surface 重建（下次渲染时）**
```
所有层: 348px  ✅ 全部一致
```

### 6.3 最终状态（6 行）

```
Canvas height: 348px
XComponent height: 348px
NativeWindow height: 348px
PluginRender m_height: 348px
WindowSurfaceHolder _height: 348px
Surface height: 348px

所有层尺寸一致 ✅
```

---

## 7. 尺寸不一致的问题

### 7.1 如果尺寸不一致会怎样？

**场景：Surface 还是旧尺寸（290px），但 Canvas 是新尺寸（348px）**

```
Canvas: 375px × 348px  ✅
Surface: 375px × 290px  ⚠️ 旧尺寸

绘制时：
- 绘制到 375px × 290px 的 Surface
- 第 6 行（Y > 290px）被裁剪
- 结果：第 6 行不显示 ❌
```

**这就是你遇到的问题！**

### 7.2 为什么会出现这个问题？

**时序问题：**
```
1. Canvas 尺寸变化 → 348px
2. XComponent 更新 → 348px
3. NativeWindow 更新 → 348px
4. PluginRender 更新 → 348px
5. WindowSurfaceHolder 更新 → 348px
6. Surface 重建 → 但可能还没重建，还是 290px ⚠️
```

**如果 Surface 重建延迟：**
- 绘制时 Surface 还是旧尺寸
- 新内容被裁剪
- 导致第 6 行不显示

### 7.3 如何避免？

**方案 1：确保 Surface 及时重建**
```cpp
// resize() 后立即重建（如果可能）
void resize(int width, int height) {
    _width = width;
    _height = height;
    _skSurface = nullptr;
    // 立即重建（如果当前有渲染上下文）
    if (makeCurrent()) {
        getSurface();  // 立即重建
    }
}
```

**方案 2：强制重绘**
```cpp
// surfaceSizeChanged 后强制重绘
void surfaceSizeChanged(int width, int height) {
    _surfaceHolder->resize(width, height);
    _requestRedraw();  // ← 强制重绘，触发 Surface 重建
}
```

**方案 3：检查尺寸一致性**
```cpp
// 渲染前检查尺寸
bool renderToCanvas(...) {
    auto surface = _surfaceHolder->getSurface();
    if (surface) {
        // 检查 Surface 尺寸是否匹配
        if (surface->width() != _surfaceHolder->getWidth() ||
            surface->height() != _surfaceHolder->getHeight()) {
            // 尺寸不匹配，强制重建
            _surfaceHolder->resize(...);
            surface = _surfaceHolder->getSurface();
        }
    }
}
```

---

## 8. 总结

### 8.1 新尺寸是什么？

**新尺寸 = 变化后的尺寸**

**例子：**
- 初始：375px × 290px（5 行）
- 新尺寸：375px × 348px（6 行）
- **新高度 = 348px**（从 290px 增加到 348px）

### 8.2 各层尺寸是否一致？

**理想情况（最终状态）：**
- ✅ 所有层尺寸一致

**实际情况（变化过程中）：**
- ⚠️ 可能存在短暂不一致
- ⚠️ Surface 重建可能延迟
- ✅ 最终所有层都会更新到新尺寸

### 8.3 关键点

1. **尺寸传递是单向的**：Canvas → XComponent → NativeWindow → Surface
2. **更新是异步的**：各层更新有先后顺序
3. **Surface 重建延迟**：发生在下次渲染时
4. **最终会一致**：所有层最终都会更新到新尺寸

### 8.4 你遇到的问题

**问题：** 从 5 行切到 6 行时，第 6 行不显示

**原因：** Surface 还是旧尺寸（290px），但内容需要新尺寸（348px）

**解决：** 确保 Surface 及时重建，使用新尺寸

---

**文档版本**: 1.0  
**最后更新**: 2025-01-XX  
**维护者**: AI Assistant
