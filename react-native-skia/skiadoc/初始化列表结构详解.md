# åˆå§‹åŒ–åˆ—è¡¨ç»“æ„è¯¦è§£

## ğŸ“‹ é—®é¢˜

ä¸ºä»€ä¹ˆåˆå§‹åŒ–åˆ—è¡¨ä¸­ `playLink` æ˜¯æœ€åä¸€ä¸ªï¼Ÿå®ƒæ˜¯ä¸æ˜¯ `RNSkPlatformContext` çš„å‚æ•°ï¼Ÿ

## ğŸ¯ ç­”æ¡ˆ

**ä¸æ˜¯ï¼** `playLink` ä¸æ˜¯ `RNSkPlatformContext` çš„å‚æ•°ï¼Œè€Œæ˜¯ `HarmonyPlatformContext` çš„**æˆå‘˜å˜é‡**ã€‚

---

## 1. åˆå§‹åŒ–åˆ—è¡¨ç»“æ„è§£æ

### 1.1 å®Œæ•´ä»£ç 

```cpp
HarmonyPlatformContext::HarmonyPlatformContext(jsi::Runtime *runtime, 
                                               std::shared_ptr<react::CallInvoker> callInvoker,
                                               float pixelDensity)
    : RNSkPlatformContext(runtime, callInvoker, pixelDensity),  // â† åŸºç±»æ„é€ å‡½æ•°
      drawLoopActive(false),                                    // â† æˆå‘˜å˜é‡åˆå§‹åŒ–
      playLink(std::make_unique<PlayLink>(...))                 // â† æˆå‘˜å˜é‡åˆå§‹åŒ–
{
    mainThread = std::thread(&HarmonyPlatformContext::runTaskOnMainThread, this);
    _runtime = runtime;
}
```

### 1.2 åˆå§‹åŒ–åˆ—è¡¨çš„ä¸‰ä¸ªéƒ¨åˆ†

```
åˆå§‹åŒ–åˆ—è¡¨
â”œâ”€ 1. åŸºç±»æ„é€ å‡½æ•°è°ƒç”¨
â”‚   â””â”€ RNSkPlatformContext(runtime, callInvoker, pixelDensity)
â”‚
â”œâ”€ 2. æˆå‘˜å˜é‡åˆå§‹åŒ– #1
â”‚   â””â”€ drawLoopActive(false)
â”‚
â””â”€ 3. æˆå‘˜å˜é‡åˆå§‹åŒ– #2
    â””â”€ playLink(std::make_unique<PlayLink>(...))
```

---

## 2. ç±»å®šä¹‰ç¡®è®¤

### 2.1 HarmonyPlatformContext ç±»å®šä¹‰

```cpp
// HarmonyPlatformContext.h:34
class HarmonyPlatformContext : public RNSkPlatformContext {
public:
    HarmonyPlatformContext(jsi::Runtime *runtime, 
                           std::shared_ptr<react::CallInvoker> callInvoker, 
                           float pixelDensity);
    // ...

private:
    bool drawLoopActive = false;              // â† æˆå‘˜å˜é‡ #1
    std::unique_ptr<PlayLink> playLink;        // â† æˆå‘˜å˜é‡ #2
    std::queue<std::function<void()>> taskQueue;
    std::mutex taskMutex;
    std::condition_variable taskCond;
    bool stopMainLoop = false;
    std::thread mainThread;
    // ...
};
```

### 2.2 å…³é”®ç‚¹

1. **`HarmonyPlatformContext` ç»§æ‰¿è‡ª `RNSkPlatformContext`**
   ```cpp
   class HarmonyPlatformContext : public RNSkPlatformContext
   ```

2. **`playLink` æ˜¯ `HarmonyPlatformContext` çš„æˆå‘˜å˜é‡**
   ```cpp
   std::unique_ptr<PlayLink> playLink;  // ç¬¬93è¡Œ
   ```

3. **æ„é€ å‡½æ•°å‚æ•°åªæœ‰ä¸‰ä¸ª**
   ```cpp
   HarmonyPlatformContext(jsi::Runtime *runtime, 
                         std::shared_ptr<react::CallInvoker> callInvoker, 
                         float pixelDensity)
   // åªæœ‰è¿™ä¸‰ä¸ªå‚æ•°ï¼Œæ²¡æœ‰ playLink å‚æ•°
   ```

---

## 3. åˆå§‹åŒ–åˆ—è¡¨è¯­æ³•è¯¦è§£

### 3.1 C++ åˆå§‹åŒ–åˆ—è¡¨è¯­æ³•

```cpp
æ„é€ å‡½æ•°å(å‚æ•°åˆ—è¡¨)
    : åŸºç±»æ„é€ å‡½æ•°(å‚æ•°),      // è°ƒç”¨åŸºç±»æ„é€ å‡½æ•°
      æˆå‘˜å˜é‡1(åˆå§‹å€¼),        // åˆå§‹åŒ–æˆå‘˜å˜é‡1
      æˆå‘˜å˜é‡2(åˆå§‹å€¼),        // åˆå§‹åŒ–æˆå‘˜å˜é‡2
      ...
{
    // æ„é€ å‡½æ•°ä½“
}
```

### 3.2 åœ¨è¿™ä¸ªä¾‹å­ä¸­

```cpp
HarmonyPlatformContext(...)
    : RNSkPlatformContext(runtime, callInvoker, pixelDensity),  // åŸºç±»æ„é€ å‡½æ•°
      drawLoopActive(false),                                    // æˆå‘˜å˜é‡
      playLink(std::make_unique<PlayLink>(...))                 // æˆå‘˜å˜é‡
```

**å¯¹åº”å…³ç³»ï¼š**

| åˆå§‹åŒ–åˆ—è¡¨é¡¹ | ç±»å‹ | è¯´æ˜ |
|------------|------|------|
| `RNSkPlatformContext(...)` | åŸºç±»æ„é€ å‡½æ•°è°ƒç”¨ | è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°ï¼Œä¼ å…¥ä¸‰ä¸ªå‚æ•° |
| `drawLoopActive(false)` | æˆå‘˜å˜é‡åˆå§‹åŒ– | åˆå§‹åŒ– `bool drawLoopActive` ä¸º `false` |
| `playLink(...)` | æˆå‘˜å˜é‡åˆå§‹åŒ– | åˆå§‹åŒ– `std::unique_ptr<PlayLink> playLink` |

---

## 4. ä¸ºä»€ä¹ˆ playLink åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­ï¼Ÿ

### 4.1 æˆå‘˜å˜é‡å¿…é¡»åœ¨æ„é€ æ—¶åˆå§‹åŒ–

**åŸå› ï¼š**
- `playLink` æ˜¯ `std::unique_ptr<PlayLink>` ç±»å‹
- æ™ºèƒ½æŒ‡é’ˆéœ€è¦åœ¨æ„é€ æ—¶åˆå§‹åŒ–
- å¦‚æœä¸åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­åˆå§‹åŒ–ï¼Œä¼šåœ¨æ„é€ å‡½æ•°ä½“æ‰§è¡Œå‰è¿›è¡Œé»˜è®¤åˆå§‹åŒ–ï¼ˆ`nullptr`ï¼‰

### 4.2 åˆå§‹åŒ–åˆ—è¡¨ vs æ„é€ å‡½æ•°ä½“

**æ–¹å¼ 1ï¼šåœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­åˆå§‹åŒ–ï¼ˆæ¨èï¼‰**
```cpp
HarmonyPlatformContext::HarmonyPlatformContext(...)
    : playLink(std::make_unique<PlayLink>(...))  // âœ… ç›´æ¥åˆå§‹åŒ–
{
    // æ„é€ å‡½æ•°ä½“
}
```

**æ–¹å¼ 2ï¼šåœ¨æ„é€ å‡½æ•°ä½“ä¸­åˆå§‹åŒ–ï¼ˆä¸æ¨èï¼‰**
```cpp
HarmonyPlatformContext::HarmonyPlatformContext(...)
    : playLink(nullptr)  // å…ˆåˆå§‹åŒ–ä¸º nullptr
{
    playLink = std::make_unique<PlayLink>(...);  // å†èµ‹å€¼ï¼ˆæ•ˆç‡ä½ï¼‰
}
```

**å¯¹æ¯”ï¼š**
- **æ–¹å¼ 1**ï¼šç›´æ¥æ„é€ ï¼Œæ•ˆç‡é«˜
- **æ–¹å¼ 2**ï¼šå…ˆé»˜è®¤æ„é€ ï¼Œå†èµ‹å€¼ï¼Œæ•ˆç‡ä½ï¼ˆå¯¹äºå¤æ‚å¯¹è±¡ï¼‰

### 4.3 ä¸ºä»€ä¹ˆå¿…é¡»ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼Ÿ

**å¯¹äºæŸäº›ç±»å‹ï¼Œå¿…é¡»ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼š**

1. **const æˆå‘˜å˜é‡**
   ```cpp
   class Example {
       const int value;
   public:
       Example(int v) : value(v) {}  // âœ… å¿…é¡»ç”¨åˆå§‹åŒ–åˆ—è¡¨
       // Example(int v) { value = v; }  // âŒ é”™è¯¯ï¼const ä¸èƒ½èµ‹å€¼
   };
   ```

2. **å¼•ç”¨æˆå‘˜å˜é‡**
   ```cpp
   class Example {
       int& ref;
   public:
       Example(int& r) : ref(r) {}  // âœ… å¿…é¡»ç”¨åˆå§‹åŒ–åˆ—è¡¨
       // Example(int& r) { ref = r; }  // âŒ é”™è¯¯ï¼å¼•ç”¨å¿…é¡»åœ¨æ„é€ æ—¶åˆå§‹åŒ–
   };
   ```

3. **æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°çš„æˆå‘˜**
   ```cpp
   class Example {
       std::unique_ptr<PlayLink> playLink;  // æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°
   public:
       Example() : playLink(std::make_unique<PlayLink>(...)) {}  // âœ… å¿…é¡»ç”¨åˆå§‹åŒ–åˆ—è¡¨
       // Example() { playLink = std::make_unique<PlayLink>(...); }  // âš ï¸ å¯ä»¥ï¼Œä½†æ•ˆç‡ä½
   };
   ```

---

## 5. åˆå§‹åŒ–é¡ºåº

### 5.1 C++ åˆå§‹åŒ–é¡ºåºè§„åˆ™

**åˆå§‹åŒ–é¡ºåºï¼š**
1. **åŸºç±»æ„é€ å‡½æ•°**ï¼ˆæŒ‰ç»§æ‰¿é¡ºåºï¼‰
2. **æˆå‘˜å˜é‡**ï¼ˆæŒ‰**å£°æ˜é¡ºåº**ï¼Œä¸æ˜¯åˆå§‹åŒ–åˆ—è¡¨é¡ºåºï¼‰

### 5.2 åœ¨è¿™ä¸ªä¾‹å­ä¸­

**ç±»å®šä¹‰ä¸­çš„å£°æ˜é¡ºåºï¼š**
```cpp
class HarmonyPlatformContext : public RNSkPlatformContext {
private:
    bool drawLoopActive = false;              // å£°æ˜é¡ºåº #1
    std::unique_ptr<PlayLink> playLink;        // å£°æ˜é¡ºåº #2
    std::queue<std::function<void()>> taskQueue;
    std::mutex taskMutex;
    std::condition_variable taskCond;
    bool stopMainLoop = false;
    std::thread mainThread;                   // å£°æ˜é¡ºåº #7
};
```

**å®é™…åˆå§‹åŒ–é¡ºåºï¼š**
```
1. RNSkPlatformContext åŸºç±»æ„é€ å‡½æ•°
2. drawLoopActive (æŒ‰å£°æ˜é¡ºåº #1)
3. playLink (æŒ‰å£°æ˜é¡ºåº #2)
4. taskQueue (æŒ‰å£°æ˜é¡ºåº #3)
5. taskMutex (æŒ‰å£°æ˜é¡ºåº #4)
6. taskCond (æŒ‰å£°æ˜é¡ºåº #5)
7. stopMainLoop (æŒ‰å£°æ˜é¡ºåº #6)
8. mainThread (æŒ‰å£°æ˜é¡ºåº #7)
```

**æ³¨æ„ï¼š** å³ä½¿åˆå§‹åŒ–åˆ—è¡¨ä¸­ `playLink` å†™åœ¨æœ€åï¼Œå®ƒä»ç„¶æŒ‰å£°æ˜é¡ºåºåˆå§‹åŒ–ï¼ˆç¬¬3ä¸ªï¼‰ã€‚

---

## 6. ä¸ºä»€ä¹ˆ playLink å†™åœ¨æœ€åï¼Ÿ

### 6.1 åˆå§‹åŒ–åˆ—è¡¨é¡ºåºå¯ä»¥è°ƒæ•´

**è™½ç„¶åˆå§‹åŒ–é¡ºåºæŒ‰å£°æ˜é¡ºåºï¼Œä½†åˆå§‹åŒ–åˆ—è¡¨çš„é¡ºåºå¯ä»¥ä»»æ„ï¼š**

```cpp
// æ–¹å¼ 1ï¼šå½“å‰å†™æ³•
: RNSkPlatformContext(...),
  drawLoopActive(false),
  playLink(...)

// æ–¹å¼ 2ï¼šä¹Ÿå¯ä»¥è¿™æ ·å†™ï¼ˆè™½ç„¶ä¸æ¨èï¼‰
: playLink(...),
  drawLoopActive(false),
  RNSkPlatformContext(...)
```

**ä½†æ¨èå†™æ³•ï¼š**
- å…ˆå†™åŸºç±»æ„é€ å‡½æ•°
- å†æŒ‰å£°æ˜é¡ºåºå†™æˆå‘˜å˜é‡
- è¿™æ ·ä»£ç æ›´æ¸…æ™°ï¼Œé¿å…æ··æ·†

### 6.2 å½“å‰ä»£ç çš„å†™æ³•

```cpp
: RNSkPlatformContext(runtime, callInvoker, pixelDensity),  // åŸºç±»ï¼ˆå¿…é¡»å…ˆåˆå§‹åŒ–ï¼‰
  drawLoopActive(false),                                    // ç®€å•æˆå‘˜å˜é‡
  playLink(std::make_unique<PlayLink>(...))                 // å¤æ‚æˆå‘˜å˜é‡ï¼ˆéœ€è¦æ„é€ å‚æ•°ï¼‰
```

**ä¸ºä»€ä¹ˆ `playLink` å†™åœ¨æœ€åï¼Ÿ**
- å› ä¸ºå®ƒçš„åˆå§‹åŒ–éœ€è¦å¤æ‚çš„ Lambda è¡¨è¾¾å¼
- å†™åœ¨æœ€åå¯ä»¥è®©ä»£ç æ›´æ¸…æ™°
- ä½†å®é™…åˆå§‹åŒ–é¡ºåºä»ç„¶æŒ‰å£°æ˜é¡ºåºï¼ˆç¬¬3ä¸ªï¼‰

---

## 7. å®Œæ•´åˆå§‹åŒ–æµç¨‹

### 7.1 æ‰§è¡Œé¡ºåº

```
HarmonyPlatformContext æ„é€ å‡½æ•°è¢«è°ƒç”¨
    â†“
1. è°ƒç”¨åŸºç±»æ„é€ å‡½æ•°
   RNSkPlatformContext(runtime, callInvoker, pixelDensity)
    â†“
2. æŒ‰å£°æ˜é¡ºåºåˆå§‹åŒ–æˆå‘˜å˜é‡
   drawLoopActive = false
    â†“
   playLink = std::make_unique<PlayLink>(Lambda)
    â†“
   taskQueue = std::queue<>()
    â†“
   taskMutex = std::mutex()
    â†“
   taskCond = std::condition_variable()
    â†“
   stopMainLoop = false
    â†“
   mainThread = std::thread()  // ä½†è¿™é‡Œè¿˜æ²¡åˆå§‹åŒ–ï¼Œåœ¨æ„é€ å‡½æ•°ä½“ä¸­åˆå§‹åŒ–
    â†“
3. æ‰§è¡Œæ„é€ å‡½æ•°ä½“
   mainThread = std::thread(&HarmonyPlatformContext::runTaskOnMainThread, this);
   _runtime = runtime;
```

### 7.2 ä¸ºä»€ä¹ˆ mainThread åœ¨æ„é€ å‡½æ•°ä½“ä¸­åˆå§‹åŒ–ï¼Ÿ

**æŸ¥çœ‹ä»£ç ï¼š**
```cpp
HarmonyPlatformContext::HarmonyPlatformContext(...)
    : RNSkPlatformContext(...),
      drawLoopActive(false),
      playLink(...)
{
    mainThread = std::thread(&HarmonyPlatformContext::runTaskOnMainThread, this);
    // â†‘ åœ¨æ„é€ å‡½æ•°ä½“ä¸­åˆå§‹åŒ–
    _runtime = runtime;
}
```

**åŸå› ï¼š**
- `mainThread` çš„åˆå§‹åŒ–éœ€è¦è°ƒç”¨ `runTaskOnMainThread` æ–¹æ³•
- æ­¤æ—¶å…¶ä»–æˆå‘˜å˜é‡ï¼ˆå¦‚ `taskQueue`ã€`taskMutex`ï¼‰å·²ç»åˆå§‹åŒ–å®Œæˆ
- å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨è¿™äº›æˆå‘˜å˜é‡

**å¦‚æœæ”¾åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­ï¼š**
```cpp
: mainThread(std::thread(&HarmonyPlatformContext::runTaskOnMainThread, this))
```

**é—®é¢˜ï¼š**
- `runTaskOnMainThread` ä¼šç«‹å³å¼€å§‹æ‰§è¡Œ
- æ­¤æ—¶ `taskQueue`ã€`taskMutex` ç­‰å¯èƒ½è¿˜æ²¡å®Œå…¨åˆå§‹åŒ–
- å¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸º

---

## 8. æ€»ç»“

### 8.1 å…³é”®ç‚¹

1. **`playLink` ä¸æ˜¯ `RNSkPlatformContext` çš„å‚æ•°**
   - å®ƒæ˜¯ `HarmonyPlatformContext` çš„æˆå‘˜å˜é‡

2. **åˆå§‹åŒ–åˆ—è¡¨åŒ…å«ä¸‰éƒ¨åˆ†**
   - åŸºç±»æ„é€ å‡½æ•°è°ƒç”¨
   - æˆå‘˜å˜é‡åˆå§‹åŒ–ï¼ˆå¯ä»¥å†™å¤šä¸ªï¼‰

3. **åˆå§‹åŒ–é¡ºåº**
   - åŸºç±»æ„é€ å‡½æ•°å…ˆæ‰§è¡Œ
   - æˆå‘˜å˜é‡æŒ‰å£°æ˜é¡ºåºåˆå§‹åŒ–ï¼ˆä¸æ˜¯åˆå§‹åŒ–åˆ—è¡¨é¡ºåºï¼‰

4. **ä¸ºä»€ä¹ˆç”¨åˆå§‹åŒ–åˆ—è¡¨**
   - æ•ˆç‡é«˜ï¼ˆç›´æ¥æ„é€ ï¼‰
   - æŸäº›ç±»å‹å¿…é¡»ç”¨ï¼ˆconstã€å¼•ç”¨ã€æ— é»˜è®¤æ„é€ å‡½æ•°ï¼‰

### 8.2 å¸¸è§è¯¯è§£

âŒ **è¯¯è§£ 1**ï¼š`playLink` æ˜¯ `RNSkPlatformContext` çš„å‚æ•°
âœ… **æ­£ç¡®**ï¼š`playLink` æ˜¯ `HarmonyPlatformContext` çš„æˆå‘˜å˜é‡

âŒ **è¯¯è§£ 2**ï¼šåˆå§‹åŒ–åˆ—è¡¨çš„é¡ºåºå†³å®šåˆå§‹åŒ–é¡ºåº
âœ… **æ­£ç¡®**ï¼šå£°æ˜é¡ºåºå†³å®šåˆå§‹åŒ–é¡ºåºï¼Œåˆå§‹åŒ–åˆ—è¡¨é¡ºåºåªæ˜¯ä»£ç ç»„ç»‡æ–¹å¼

âŒ **è¯¯è§£ 3**ï¼šæ‰€æœ‰æˆå‘˜å˜é‡éƒ½å¿…é¡»åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­åˆå§‹åŒ–
âœ… **æ­£ç¡®**ï¼šå¯ä»¥åœ¨æ„é€ å‡½æ•°ä½“ä¸­åˆå§‹åŒ–ï¼Œä½†åˆå§‹åŒ–åˆ—è¡¨æ›´é«˜æ•ˆ

---

## 9. ä»£ç å¯¹æ¯”

### 9.1 ç­‰ä»·çš„å†™æ³•ï¼ˆä¸æ¨èï¼‰

```cpp
// æ–¹å¼ 1ï¼šå½“å‰å†™æ³•ï¼ˆæ¨èï¼‰
HarmonyPlatformContext::HarmonyPlatformContext(...)
    : RNSkPlatformContext(runtime, callInvoker, pixelDensity),
      drawLoopActive(false),
      playLink(std::make_unique<PlayLink>(...))
{
    mainThread = std::thread(...);
    _runtime = runtime;
}

// æ–¹å¼ 2ï¼šåœ¨æ„é€ å‡½æ•°ä½“ä¸­åˆå§‹åŒ–ï¼ˆä¸æ¨èï¼Œæ•ˆç‡ä½ï¼‰
HarmonyPlatformContext::HarmonyPlatformContext(...)
    : RNSkPlatformContext(runtime, callInvoker, pixelDensity)
{
    drawLoopActive = false;  // å¯ä»¥ï¼Œä½†æ•ˆç‡ä½
    playLink = std::make_unique<PlayLink>(...);  // å¯ä»¥ï¼Œä½†æ•ˆç‡ä½
    mainThread = std::thread(...);
    _runtime = runtime;
}
```

### 9.2 ä¸ºä»€ä¹ˆæ¨èæ–¹å¼ 1ï¼Ÿ

- âœ… **æ•ˆç‡é«˜**ï¼šç›´æ¥æ„é€ ï¼Œä¸å…ˆé»˜è®¤æ„é€ å†èµ‹å€¼
- âœ… **ä»£ç æ¸…æ™°**ï¼šåˆå§‹åŒ–é€»è¾‘é›†ä¸­
- âœ… **ç±»å‹å®‰å…¨**ï¼šæŸäº›ç±»å‹å¿…é¡»ç”¨åˆå§‹åŒ–åˆ—è¡¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ç»´æŠ¤è€…**: AI Assistant
