# react-native-skia å®Œæ•´æµç¨‹ - ä» Canvas åˆ°ä¸Šå±

## ğŸ“‹ å®Œæ•´æµç¨‹æ¦‚è§ˆ

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°ä» Canvas ç»„ä»¶åˆ›å»ºåˆ°æœ€ç»ˆä¸Šå±æ˜¾ç¤ºçš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ­¥éª¤å’Œå°ºå¯¸ä¼ é€’ã€‚

---

## 1. åˆå§‹åŒ–é˜¶æ®µï¼ˆå°ºå¯¸ä¼ é€’ï¼‰

### 1.1 Canvas ç»„ä»¶å®šä¹‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React Native JS å±‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  <Canvas                                           â”‚ â”‚
â”‚  â”‚    style={{                                        â”‚ â”‚
â”‚  â”‚      width: '100%',        â† ç›¸å¯¹å®½åº¦             â”‚ â”‚
â”‚  â”‚      height: gridHeight     â† è®¡ç®—é«˜åº¦ (400px)     â”‚ â”‚
â”‚  â”‚    }}>                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ RNOH å¸ƒå±€ç³»ç»Ÿè®¡ç®—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®é™…å°ºå¯¸ï¼š375px Ã— 400px                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
```

### 1.2 RNOH æ¡¥æ¥å±‚è·å–å°ºå¯¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RNCSkiaDomView.ets                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  updatePropFromDesc() {                          â”‚ â”‚
â”‚  â”‚    this.viewWidth =                               â”‚ â”‚
â”‚  â”‚      descriptor.layoutMetrics.frame.size.width    â”‚ â”‚
â”‚  â”‚      // 375px                                     â”‚ â”‚
â”‚  â”‚    this.viewHeight =                              â”‚ â”‚
â”‚  â”‚      descriptor.layoutMetrics.frame.size.height    â”‚ â”‚
â”‚  â”‚      // 400px                                     â”‚ â”‚
â”‚  â”‚  }                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ä¼ é€’ç»™
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SkiaDomView({                                          â”‚
â”‚    viewWidth: 375px,                                    â”‚
â”‚    viewHeight: 400px                                    â”‚
â”‚  })                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
```

### 1.3 XComponent ä½¿ç”¨å°ºå¯¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SkiaDomView.ets                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  XComponent({                                      â”‚ â”‚
â”‚  â”‚    width: this.viewWidth,   // 375px              â”‚ â”‚
â”‚  â”‚    height: this.viewHeight  // 400px               â”‚ â”‚
â”‚  â”‚  })                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ç³»ç»Ÿåˆ›å»º
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿåˆ›å»º NativeWindow                                  â”‚
â”‚  å°ºå¯¸ï¼š375px Ã— 400px                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ OnSurfaceCreated å›è°ƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  plugin_render.cpp                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  OH_NativeXComponent_GetXComponentSize(            â”‚ â”‚
â”‚  â”‚    component, window, &width, &height             â”‚ â”‚
â”‚  â”‚  )                                                â”‚ â”‚
â”‚  â”‚  // width: 375px, height: 400px                  â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  render->m_width = width;   // 375px             â”‚ â”‚
â”‚  â”‚  render->m_height = height; // 400px              â”‚ â”‚
â”‚  â”‚  render->m_window = nativeWindow;                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ surfaceAvailable()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RNSkOpenGLCanvasProvider.h                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  surfaceAvailable(window, width, height)          â”‚ â”‚
â”‚  â”‚    â†“                                              â”‚ â”‚
â”‚  â”‚  WindowSurfaceHolder(window, width, height)       â”‚ â”‚
â”‚  â”‚    â†“                                              â”‚ â”‚
â”‚  â”‚  _width = width;   // 375px                       â”‚ â”‚
â”‚  â”‚  _height = height; // 400px                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ getSurface() (é¦–æ¬¡æ¸²æŸ“æ—¶)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WindowSurfaceHolder::getSurface()                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  GrBackendRenderTargets::MakeGL(                 â”‚ â”‚
â”‚  â”‚    _width, _height, ...  // 375px, 400px         â”‚ â”‚
â”‚  â”‚  )                                                â”‚ â”‚
â”‚  â”‚    â†“                                              â”‚ â”‚
â”‚  â”‚  SkSurfaces::WrapBackendRenderTarget(...)         â”‚ â”‚
â”‚  â”‚    â†“                                              â”‚ â”‚
â”‚  â”‚  SkSurface åˆ›å»ºå®Œæˆ (å°ºå¯¸: 375px Ã— 400px)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ³¨å†Œå’Œç»‘å®šé˜¶æ®µ

### 2.1 XComponent.onLoad å›è°ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SkiaDomView.ets:44                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  .onLoad((xComponentContext) => {                 â”‚ â”‚
â”‚  â”‚    this.xComponentContext?.registerView(           â”‚ â”‚
â”‚  â”‚      X_COMPONENT_ID + "_" + this.nativeID,       â”‚ â”‚
â”‚  â”‚      this.nativeID                                â”‚ â”‚
â”‚  â”‚    );                                             â”‚ â”‚
â”‚  â”‚  })                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ NAPI è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PluginRender::RegisterView()                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è§£æå‚æ•°ï¼šxComponentId, nativeId            â”‚
â”‚  â”‚  â”‚                                                  â”‚
â”‚  â”‚  2. é€šè¿‡ ID è·å– PluginRender å®ä¾‹                 â”‚
â”‚  â”‚  â”‚                                                  â”‚
â”‚  â”‚  3. åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œ                                â”‚
â”‚  â”‚  â”‚                                                  â”‚
â”‚  â”‚  4. è·å– RNSkView                                  â”‚
â”‚  â”‚  â”‚                                                  â”‚
â”‚  â”‚  5. æ³¨å†Œåˆ° SkiaManager                             â”‚
â”‚  â”‚  â”‚    SkiaManager::registerSkiaView(nId, rNSkView) â”‚
â”‚  â”‚  â”‚                                                  â”‚
â”‚  â”‚  6. è°ƒç”¨ surfaceAvailable()                        â”‚
â”‚  â”‚     view->surfaceAvailable(window, 1, 1)          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RNSkHarmonyView::surfaceAvailable()                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è°ƒç”¨ CanvasProvider::surfaceAvailable()       â”‚
â”‚  â”‚     â””â”€ åˆ›å»º WindowSurfaceHolder                   â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. ç«‹å³æ¸²æŸ“                                       â”‚
â”‚  â”‚     RNSkView::renderImmediate()                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Surface åˆ›å»ºé˜¶æ®µ

### 3.1 WindowSurfaceHolder åˆ›å»º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RNSkOpenGLCanvasProvider::surfaceAvailable()            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  _surfaceHolder =                                 â”‚ â”‚
â”‚  â”‚    SkiaOpenGLSurfaceFactory::makeWindowedSurface( â”‚ â”‚
â”‚  â”‚      surface, width, height                       â”‚ â”‚
â”‚  â”‚    )                                              â”‚ â”‚
â”‚  â”‚    â†“                                              â”‚ â”‚
â”‚  â”‚  åˆ›å»º WindowSurfaceHolder                         â”‚
â”‚  â”‚    â”œâ”€ _window = OHNativeWindow*                  â”‚
â”‚  â”‚    â”œâ”€ _width = width                             â”‚
â”‚  â”‚    â”œâ”€ _height = height                           â”‚
â”‚  â”‚    â”œâ”€ _glSurface = EGL_NO_SURFACE (åˆå§‹ä¸ºç©º)     â”‚
â”‚  â”‚    â””â”€ _skSurface = nullptr (åˆå§‹ä¸ºç©º)            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ renderImmediate() è§¦å‘é¦–æ¬¡æ¸²æŸ“
```

### 3.2 é¦–æ¬¡æ¸²æŸ“ - getSurface()

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RNSkView::renderImmediate()                            â”‚
â”‚    â†“                                                    â”‚
â”‚  RNSkOpenGLCanvasProvider::renderToCanvas()             â”‚
â”‚    â†“                                                    â”‚
â”‚  WindowSurfaceHolder::getSurface()                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  getSurface() æ‰§è¡Œæµç¨‹                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. æ£€æŸ¥ _skSurface æ˜¯å¦ä¸º nullptr                â”‚
â”‚  â”‚     if (_skSurface == nullptr) {                  â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. åˆ›å»º/ç¡®ä¿ Skia DirectContext                   â”‚
â”‚  â”‚     SkiaOpenGLHelper::createSkiaDirectContextIfNecessary() â”‚
â”‚  â”‚     â”œâ”€ åˆå§‹åŒ– EGL display/context                 â”‚
â”‚  â”‚     â””â”€ åˆ›å»º GrDirectContext                       â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  3. åˆ›å»º EGLSurface                                â”‚
â”‚  â”‚     _glSurface = createWindowedSurface(_window)   â”‚
â”‚  â”‚     â””â”€ ä» OHNativeWindow åˆ›å»º EGLSurface          â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  4. ç»‘å®š EGLSurface                                â”‚
â”‚  â”‚     makeCurrent(..., _glSurface)                  â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  5. åˆ›å»º GrBackendRenderTarget                    â”‚
â”‚  â”‚     GrBackendRenderTargets::MakeGL(               â”‚
â”‚  â”‚       _width, _height, samples, stencil, fboInfo   â”‚
â”‚  â”‚     )                                              â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  6. åˆ›å»º SkSurface                                 â”‚
â”‚  â”‚     SkSurfaces::WrapBackendRenderTarget(...)      â”‚
â”‚  â”‚     â””â”€ ä» GrBackendRenderTarget åˆ›å»º SkSurface  â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  7. é‡ç½® Canvas çŸ©é˜µ                               â”‚
â”‚  â”‚     canvas->resetMatrix()                         â”‚
â”‚  â”‚     canvas->clipRect(SkRect::MakeWH(_width, _height)) â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  8. è¿”å› _skSurface                                â”‚
â”‚  â”‚     return _skSurface;                            â”‚
â”‚  â”‚  }                                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. æ¸²æŸ“å¾ªç¯é˜¶æ®µ

### 4.1 PlayLink å®šæ—¶è§¦å‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HarmonyPlayLink::postFrameLoop()                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  while (running) {                                â”‚ â”‚
â”‚  â”‚    1. sleep_until(nextTime)  // ç¡çœ  16.667ms     â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚    2. è®¡ç®— deltaTime                              â”‚ â”‚
â”‚  â”‚       deltaTime = currentTime - lastTime          â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚    3. è°ƒç”¨å›è°ƒ                                    â”‚ â”‚
â”‚  â”‚       CallBack(deltaTime)                         â”‚ â”‚
â”‚  â”‚       â””â”€ å¤–å±‚ Lambda                              â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚    4. è®¡ç®—ä¸‹æ¬¡æ—¶é—´                                â”‚ â”‚
â”‚  â”‚       nextTime = lastTime + interval              â”‚ â”‚
â”‚  â”‚  }                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ CallBack(deltaTime)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤–å±‚ Lambda: [this](double deltaTime)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  runOnMainThread([this](){                        â”‚ â”‚
â”‚  â”‚    notifyDrawLoop(false);                         â”‚ â”‚
â”‚  â”‚  })                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HarmonyPlatformContext::runTaskOnMainThread()            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—                                   â”‚ â”‚
â”‚  â”‚     taskQueue.push(task)                         â”‚ â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. é€šçŸ¥ä»»åŠ¡çº¿ç¨‹                                   â”‚
â”‚  â”‚     taskCond.notify_one()                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ä»»åŠ¡çº¿ç¨‹æ‰§è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HarmonyPlatformContext::runTaskOnMainThread()           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. ä»é˜Ÿåˆ—å–å‡ºä»»åŠ¡                                 â”‚ â”‚
â”‚  â”‚     task = taskQueue.front()                     â”‚ â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. æ‰§è¡Œä»»åŠ¡                                       â”‚ â”‚
â”‚  â”‚     task()  // æ‰§è¡Œ notifyDrawLoop(false)        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HarmonyPlatformContext::notifyDrawLoop()                â”‚
â”‚    â†“                                                    â”‚
â”‚  RNSkView::draw()                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
```

### 4.2 renderToCanvas æ‰§è¡Œç»˜åˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RNSkOpenGLCanvasProvider::renderToCanvas(cb)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è·å– Surface                                   â”‚
â”‚  â”‚     surface = _surfaceHolder->getSurface()       â”‚
â”‚  â”‚     â””â”€ å¦‚æœä¸º nullptrï¼Œä¼šåˆ›å»ºï¼ˆè§ 3.2ï¼‰           â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. ç»‘å®š EGLSurface                                â”‚
â”‚  â”‚     if (!_surfaceHolder->makeCurrent()) {         â”‚
â”‚  â”‚       return false;                               â”‚
â”‚  â”‚     }                                              â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  3. æ›´æ–°çº¹ç†å›¾åƒ                                   â”‚
â”‚  â”‚     _surfaceHolder->updateTexImage()              â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  4. è·å– Canvas                                  â”‚
â”‚  â”‚     SkCanvas* canvas = surface->getCanvas()      â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  5. é‡ç½® Canvas çŠ¶æ€                               â”‚
â”‚  â”‚     canvas->save()                                â”‚
â”‚  â”‚     canvas->resetMatrix()                        â”‚
â”‚  â”‚     canvas->clipRect(SkRect::MakeWH(width, height)) â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  6. æ‰§è¡Œç»˜åˆ¶å›è°ƒ                                   â”‚
â”‚  â”‚     cb(canvas)                                    â”‚
â”‚  â”‚     â””â”€ æ‰§è¡Œ JS å±‚çš„ç»˜åˆ¶é€»è¾‘                        â”‚
â”‚  â”‚        â”œâ”€ canvas->drawRect(...)                   â”‚
â”‚  â”‚        â”œâ”€ canvas->drawText(...)                   â”‚
â”‚  â”‚        â””â”€ canvas->drawImage(...)                  â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  7. æ¢å¤ Canvas çŠ¶æ€                              â”‚
â”‚  â”‚     canvas->restore()                            â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  8. æäº¤å¹¶ä¸Šå±                                     â”‚
â”‚  â”‚     return _surfaceHolder->present()              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
```

### 4.3 present() æäº¤æ¸²æŸ“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WindowSurfaceHolder::present()                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. åˆ·æ–°å¹¶æäº¤ GPU å‘½ä»¤                            â”‚
â”‚  â”‚     directContext->flushAndSubmit()               â”‚
â”‚  â”‚     â”œâ”€ flush() â†’ å‘é€å‘½ä»¤åˆ° GPU é©±åŠ¨              â”‚
â”‚  â”‚     â””â”€ submit() â†’ æäº¤æ‰§è¡Œ                        â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. äº¤æ¢å‰åç¼“å†²åŒº                                 â”‚
â”‚  â”‚     SkiaOpenGLHelper::swapBuffers(                â”‚
â”‚  â”‚       display, _glSurface                         â”‚
â”‚  â”‚     )                                              â”‚
â”‚  â”‚     â”œâ”€ ç­‰å¾… VSyncï¼ˆå¦‚æœå¯ç”¨ï¼‰                     â”‚
â”‚  â”‚     â””â”€ eglSwapBuffers() â†’ äº¤æ¢ç¼“å†²åŒº              â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  3. è¿”å›ç»“æœ                                       â”‚
â”‚  â”‚     return true/false                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿåˆæˆå™¨                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è·å–åç¼“å†²åŒºå†…å®¹                               â”‚
â”‚  â”‚     (swapBuffers åï¼Œåç¼“å†²åŒºå˜æˆå‰ç¼“å†²åŒº)         â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. åˆæˆåˆ°å±å¹•                                      â”‚
â”‚  â”‚     æ˜¾ç¤ºåœ¨ XComponent å¯¹åº”çš„ä½ç½®                   â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  3. ç”¨æˆ·çœ‹åˆ°ç”»é¢                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å°ºå¯¸å˜åŒ–å¤„ç†é˜¶æ®µ

### 5.1 Canvas å°ºå¯¸å˜åŒ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React Native JS å±‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  <Canvas                                          â”‚
â”‚  â”‚    style={{                                        â”‚
â”‚  â”‚      height: gridHeight  // ä» 290px â†’ 348px      â”‚
â”‚  â”‚    }}>                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ RNOH å¸ƒå±€ç³»ç»Ÿé‡æ–°è®¡ç®—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–°å°ºå¯¸ï¼š375px Ã— 348px                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RNCSkiaDomView.ets                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  updatePropFromDesc() {                          â”‚
â”‚  â”‚    this.viewHeight = 348px  // æ–°é«˜åº¦             â”‚
â”‚  â”‚  }                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SkiaDomView.ets                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  XComponent å°ºå¯¸æ›´æ–°                              â”‚
â”‚  â”‚    .height(this.viewHeight)  // 348px             â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  onSizeChange è§¦å‘                                â”‚ â”‚
â”‚  â”‚    .onSizeChange((oldValue, newValue) => {       â”‚ â”‚
â”‚  â”‚      let height = newValue.height;  // 348px      â”‚ â”‚
â”‚  â”‚      onSurfaceSizeChanged(..., height)           â”‚ â”‚
â”‚  â”‚    })                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ NAPI è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PluginRender::SurfaceSizeChanged()                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è§£æå‚æ•°ï¼šwidth, height                       â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. æ›´æ–° PluginRender å°ºå¯¸                        â”‚
â”‚  â”‚     instance->m_width = width;                   â”‚
â”‚  â”‚     instance->m_height = height;  // 348px        â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  3. åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œ                              â”‚
â”‚  â”‚     runOnMainThread([...]() {                    â”‚
â”‚  â”‚       view->surfaceSizeChanged(width, height)     â”‚
â”‚  â”‚     })                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RNSkHarmonyView::surfaceSizeChanged()                   â”‚
â”‚    â†“                                                    â”‚
â”‚  RNSkOpenGLCanvasProvider::surfaceSizeChanged()         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. æ£€æŸ¥å°ºå¯¸æœ‰æ•ˆæ€§                                 â”‚
â”‚  â”‚     if (width == 0 && height == 0) return;        â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. è°ƒç”¨ resize()                                 â”‚
â”‚  â”‚     _surfaceHolder->resize(width, height)         â”‚
â”‚  â”‚     â””â”€ _width = width;                            â”‚
â”‚  â”‚     â””â”€ _height = height;  // 348px                â”‚
â”‚  â”‚     â””â”€ _skSurface = nullptr;  // æ ‡è®°éœ€è¦é‡å»º     â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  3. è¯·æ±‚é‡ç»˜                                       â”‚
â”‚  â”‚     _requestRedraw()                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ä¸‹æ¬¡æ¸²æŸ“æ—¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  renderToCanvas() â†’ getSurface()                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  if (_skSurface == nullptr) {  // éœ€è¦é‡å»º       â”‚
â”‚  â”‚    // ä½¿ç”¨æ–°çš„ _width å’Œ _height é‡å»º Surface   â”‚
â”‚  â”‚    // å°ºå¯¸ï¼š375px Ã— 348px                        â”‚
â”‚  â”‚  }                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. é”€æ¯é˜¶æ®µ

### 6.1 Canvas ç»„ä»¶å¸è½½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React Native JS å±‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Canvas ç»„ä»¶ä»ç»„ä»¶æ ‘ä¸­ç§»é™¤                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SkiaDomView.aboutToDisappear()                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  this.xComponentContext?.unregisterView(         â”‚
â”‚  â”‚    X_COMPONENT_ID + "_" + this.nativeID,         â”‚
â”‚  â”‚    this.nativeID                                 â”‚
â”‚  â”‚  )                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ NAPI è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PluginRender::DropInstance()                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è§£æå‚æ•°ï¼šxComponentId, nativeId             â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. æ³¨é”€ Skia View                                â”‚
â”‚  â”‚     SkiaManager::setSkiaView(nId, nullptr)       â”‚
â”‚  â”‚     SkiaManager::unregisterSkiaView(nId)         â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  3. é€šçŸ¥ View å¸è½½                                 â”‚
â”‚  â”‚     harmonyView->viewDidUnmount()                â”‚
â”‚  â”‚     â””â”€ RNSkView::endDrawingLoop()                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HarmonyPlatformContext::stopDrawLoop()                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è®¾ç½® drawLoopActive = false                  â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. åœæ­¢ PlayLink                                 â”‚
â”‚  â”‚     playLink->stopDrawLoop()                     â”‚
â”‚  â”‚     â””â”€ running = false                           â”‚
â”‚  â”‚     â””â”€ thread->join()                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OnSurfaceDestroyed ç³»ç»Ÿå›è°ƒ                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. è·å– XComponent ID                           â”‚
â”‚  â”‚     OH_NativeXComponent_GetXComponentId(...)      â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. è·å– PluginRender å®ä¾‹                        â”‚
â”‚  â”‚     render = PluginRender::GetInstance(id)       â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  3. é€šçŸ¥ Surface é”€æ¯                             â”‚
â”‚  â”‚     render->_harmonyView->surfaceDestroyed()     â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  4. é‡Šæ”¾å®ä¾‹                                       â”‚
â”‚  â”‚     PluginRender::Release(id)                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RNSkHarmonyView::surfaceDestroyed()                     â”‚
â”‚    â†“                                                    â”‚
â”‚  RNSkOpenGLCanvasProvider::surfaceDestroyed()           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. ç§»åŠ¨ surfaceHolder                            â”‚
â”‚  â”‚     auto holder = std::move(_surfaceHolder)       â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œæ¸…ç†                           â”‚
â”‚  â”‚     runOnMainThread([holder]() {                 â”‚
â”‚  â”‚       holder->dispose()                           â”‚
â”‚  â”‚     })                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WindowSurfaceHolder::dispose()                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. é‡Šæ”¾ SkSurface                                 â”‚
â”‚  â”‚     _skSurface.reset()                            â”‚
â”‚  â”‚     _glSurface = EGL_NO_SURFACE                    â”‚
â”‚  â”‚                                                    â”‚
â”‚  â”‚  2. é”€æ¯ NativeWindow                              â”‚
â”‚  â”‚     OH_NativeWindow_DestroyNativeWindow(_window)   â”‚
â”‚  â”‚     _window = nullptr                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. å®Œæ•´æµç¨‹å›¾ï¼ˆæ—¶åºå›¾ï¼‰

```mermaid
sequenceDiagram
    participant JS as React JS
    participant RNOH as RNOH æ¡¥æ¥
    participant ArkTS as ArkTS
    participant System as ç³»ç»Ÿ
    participant NAPI as NAPI
    participant C++ as C++ Skia
    participant GL as OpenGL/EGL
    
    Note over JS,GL: åˆå§‹åŒ–é˜¶æ®µ
    JS->>RNOH: Canvas ç»„ä»¶æ¸²æŸ“
    RNOH->>RNOH: å¸ƒå±€è®¡ç®— (375px Ã— 400px)
    RNOH->>ArkTS: åˆ›å»º SkiaDomView (viewWidth, viewHeight)
    ArkTS->>ArkTS: XComponent (width, height)
    ArkTS->>System: ç³»ç»Ÿåˆ›å»º NativeWindow
    System->>NAPI: OnSurfaceCreated (window, width, height)
    NAPI->>C++: PluginRender::GetInstance(id)
    NAPI->>C++: render->m_window = window
    NAPI->>C++: render->m_width = width
    NAPI->>C++: render->m_height = height
    
    Note over JS,GL: æ³¨å†Œé˜¶æ®µ
    ArkTS->>NAPI: registerView (id, nativeId)
    NAPI->>C++: PluginRender::RegisterView()
    C++->>C++: SkiaManager::registerSkiaView()
    C++->>C++: surfaceAvailable(window, 1, 1)
    C++->>C++: åˆ›å»º WindowSurfaceHolder
    C++->>C++: renderImmediate()
    
    Note over JS,GL: é¦–æ¬¡æ¸²æŸ“
    C++->>C++: renderToCanvas()
    C++->>C++: getSurface()
    C++->>GL: createWindowedSurface(window)
    GL->>C++: EGLSurface
    C++->>GL: MakeGL(_width, _height)
    GL->>C++: GrBackendRenderTarget
    C++->>C++: WrapBackendRenderTarget()
    C++->>C++: SkSurface
    C++->>C++: canvas->resetMatrix()
    C++->>JS: cb(canvas) - æ‰§è¡Œç»˜åˆ¶
    JS->>C++: canvas->drawXXX()
    C++->>GL: flushAndSubmit()
    C++->>GL: swapBuffers()
    GL->>System: ç³»ç»Ÿåˆæˆ
    System->>System: æ˜¾ç¤ºåˆ°å±å¹•
    
    Note over JS,GL: æŒç»­æ¸²æŸ“å¾ªç¯
    loop æ¯ 16.667ms
        C++->>C++: PlayLink è§¦å‘
        C++->>C++: notifyDrawLoop()
        C++->>C++: renderToCanvas()
        C++->>JS: cb(canvas)
        JS->>C++: canvas->drawXXX()
        C++->>GL: flushAndSubmit()
        C++->>GL: swapBuffers()
        GL->>System: æ˜¾ç¤º
    end
    
    Note over JS,GL: å°ºå¯¸å˜åŒ–
    JS->>RNOH: Canvas height å˜åŒ– (290px â†’ 348px)
    RNOH->>ArkTS: viewHeight = 348px
    ArkTS->>ArkTS: XComponent height = 348px
    ArkTS->>ArkTS: onSizeChange è§¦å‘
    ArkTS->>NAPI: onSurfaceSizeChanged(id, width, height)
    NAPI->>C++: PluginRender::SurfaceSizeChanged()
    C++->>C++: render->m_height = 348px
    C++->>C++: surfaceSizeChanged(width, height)
    C++->>C++: resize(width, height)
    C++->>C++: _height = 348px
    C++->>C++: _skSurface = nullptr
    C++->>C++: _requestRedraw()
    Note over C++: ä¸‹æ¬¡æ¸²æŸ“æ—¶é‡å»º Surface (375px Ã— 348px)
    
    Note over JS,GL: é”€æ¯é˜¶æ®µ
    JS->>RNOH: Canvas ç»„ä»¶å¸è½½
    ArkTS->>ArkTS: aboutToDisappear()
    ArkTS->>NAPI: unregisterView(id, nativeId)
    NAPI->>C++: PluginRender::DropInstance()
    C++->>C++: SkiaManager::unregisterSkiaView()
    C++->>C++: viewDidUnmount()
    C++->>C++: stopDrawLoop()
    System->>NAPI: OnSurfaceDestroyed
    NAPI->>C++: surfaceDestroyed()
    C++->>C++: dispose()
    C++->>GL: é”€æ¯ EGLSurface
    C++->>System: é”€æ¯ NativeWindow
    C++->>C++: PluginRender::Release(id)
```

---

## 8. å…³é”®æ•°æ®æµ

### 8.1 å°ºå¯¸æ•°æ®æµ

```
Canvas style (width: '100%', height: gridHeight)
    â†“ RNOH å¸ƒå±€è®¡ç®—
å®é™…å°ºå¯¸ (375px Ã— 400px)
    â†“
XComponent (viewWidth: 375px, viewHeight: 400px)
    â†“ ç³»ç»Ÿåˆ›å»º
NativeWindow (375px Ã— 400px)
    â†“ OnSurfaceCreated
PluginRender (m_width: 375px, m_height: 400px)
    â†“ surfaceAvailable
WindowSurfaceHolder (_width: 375px, _height: 400px)
    â†“ getSurface()
Surface (375px Ã— 400px)
```

### 8.2 çª—å£æ•°æ®æµ

```
XComponent
    â†“ ç³»ç»Ÿåˆ›å»º
OHNativeWindow*
    â†“ OnSurfaceCreated
PluginRender (m_window)
    â†“ surfaceAvailable
WindowSurfaceHolder (_window)
    â†“ createWindowedSurface
EGLSurface
    â†“ WrapBackendRenderTarget
SkSurface
```

### 8.3 ç»˜åˆ¶æ•°æ®æµ

```
JS å±‚ç»˜åˆ¶æŒ‡ä»¤
    â†“ JSI
SkiaManager
    â†“
RNSkView::draw()
    â†“
RNSkOpenGLCanvasProvider::renderToCanvas(cb)
    â†“
cb(canvas) â†’ canvas->drawXXX()
    â†“
SkCanvas ç»˜åˆ¶å‘½ä»¤
    â†“ flushAndSubmit
GPU æ‰§è¡Œ
    â†“ swapBuffers
ç³»ç»Ÿåˆæˆ
    â†“
å±å¹•æ˜¾ç¤º
```

---

## 9. æ€»ç»“

### 9.1 å®Œæ•´æµç¨‹é˜¶æ®µ

1. **åˆå§‹åŒ–é˜¶æ®µ**ï¼šCanvas â†’ XComponent â†’ NativeWindow â†’ PluginRender â†’ WindowSurfaceHolder
2. **æ³¨å†Œé˜¶æ®µ**ï¼šregisterView â†’ ç»‘å®š nativeID â†” RNSkView â†’ surfaceAvailable
3. **Surface åˆ›å»ºé˜¶æ®µ**ï¼šgetSurface() â†’ EGLSurface â†’ SkSurface
4. **æ¸²æŸ“å¾ªç¯é˜¶æ®µ**ï¼šPlayLink â†’ notifyDrawLoop â†’ renderToCanvas â†’ present â†’ ä¸Šå±
5. **å°ºå¯¸å˜åŒ–é˜¶æ®µ**ï¼šonSizeChange â†’ surfaceSizeChanged â†’ resize â†’ é‡å»º Surface
6. **é”€æ¯é˜¶æ®µ**ï¼šunregisterView â†’ surfaceDestroyed â†’ dispose â†’ é‡Šæ”¾èµ„æº

### 9.2 å…³é”®ç‚¹

- **å°ºå¯¸ä¼ é€’**ï¼šCanvas â†’ XComponent â†’ NativeWindow â†’ Surfaceï¼ˆæ‰€æœ‰å±‚å°ºå¯¸ä¸€è‡´ï¼‰
- **çª—å£ä¼ é€’**ï¼šXComponent â†’ NativeWindow â†’ EGLSurface â†’ SkSurface
- **ç»˜åˆ¶æµç¨‹**ï¼šJS â†’ Skia â†’ GPU â†’ ç³»ç»Ÿåˆæˆ â†’ å±å¹•
- **ä¸€ä¸€å¯¹åº”**ï¼š1 ä¸ª Canvas â†’ 1 ä¸ª XComponent â†’ 1 ä¸ª NativeWindow â†’ 1 ä¸ª PluginRender å®ä¾‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ç»´æŠ¤è€…**: AI Assistant
